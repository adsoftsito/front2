/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { cloneArray, isEqual, mergeObjects } from '../core/utils';
import { DataUtil, DataType } from '../data-operations/data-util';
import { SortingDirection } from '../data-operations/sorting-expression.interface';
import { FilteringExpressionsTree } from '../data-operations/filtering-expressions-tree';
import { TransactionType } from '../services/index';
// unsupported: template constraints.
/**
 * @hidden
 * @template T
 */
var GridBaseAPIService = /** @class */ (function () {
    function GridBaseAPIService() {
        this.change = new Subject();
        this.state = new Map();
        this.editCellState = new Map();
        this.editRowState = new Map();
        this.summaryCacheMap = new Map();
        this.destroyMap = new Map();
    }
    /**
     * @param {?} grid
     * @return {?}
     */
    GridBaseAPIService.prototype.register = /**
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        this.state.set(grid.id, grid);
        this.destroyMap.set(grid.id, new Subject());
    };
    /**
     * @param {?} grid
     * @return {?}
     */
    GridBaseAPIService.prototype.unsubscribe = /**
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        this.state.delete(grid.id);
    };
    /**
     * @param {?} id
     * @return {?}
     */
    GridBaseAPIService.prototype.get = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.state.get(id);
    };
    /**
     * @param {?} id
     * @return {?}
     */
    GridBaseAPIService.prototype.unset = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        this.state.delete(id);
        this.summaryCacheMap.delete(id);
        this.editCellState.delete(id);
        this.editRowState.delete(id);
        this.destroyMap.delete(id);
    };
    /**
     * @param {?} oldId
     * @param {?} newId
     * @return {?}
     */
    GridBaseAPIService.prototype.reset = /**
     * @param {?} oldId
     * @param {?} newId
     * @return {?}
     */
    function (oldId, newId) {
        var /** @type {?} */ destroy = this.destroyMap.get(oldId);
        var /** @type {?} */ summary = this.summaryCacheMap.get(oldId);
        var /** @type {?} */ editCellState = this.editCellState.get(oldId);
        var /** @type {?} */ editRowState = this.editRowState.get(oldId);
        var /** @type {?} */ grid = this.get(oldId);
        this.unset(oldId);
        if (grid) {
            this.state.set(newId, grid);
        }
        if (destroy) {
            this.destroyMap.set(newId, destroy);
        }
        if (summary) {
            this.summaryCacheMap.set(newId, summary);
        }
        if (editCellState) {
            this.editCellState.set(newId, editCellState);
        }
        if (editRowState) {
            this.editRowState.set(newId, editRowState);
        }
    };
    /**
     * @param {?} id
     * @param {?} name
     * @return {?}
     */
    GridBaseAPIService.prototype.get_column_by_name = /**
     * @param {?} id
     * @param {?} name
     * @return {?}
     */
    function (id, name) {
        return this.get(id).columnList.find(function (col) { return col.field === name; });
    };
    /**
     * @param {?} id
     * @param {?} name
     * @return {?}
     */
    GridBaseAPIService.prototype.set_summary_by_column_name = /**
     * @param {?} id
     * @param {?} name
     * @return {?}
     */
    function (id, name) {
        if (!this.summaryCacheMap.get(id)) {
            this.summaryCacheMap.set(id, new Map());
        }
        var /** @type {?} */ column = this.get_column_by_name(id, name);
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ data = grid.filteredData;
        if (!data) {
            if (grid.transactions.enabled) {
                data = DataUtil.mergeTransactions(cloneArray(grid.data), grid.transactions.getAggregatedChanges(true), grid.primaryKey);
            }
            else {
                data = grid.data;
            }
        }
        if (data) {
            var /** @type {?} */ columnValues = data.map(function (rec) { return rec[column.field]; });
            this.calculateSummaries(id, column, columnValues);
        }
    };
    /**
     * @param {?} id
     * @return {?}
     */
    GridBaseAPIService.prototype.get_summaries = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.summaryCacheMap.get(id);
    };
    /**
     * @param {?} id
     * @param {?=} name
     * @return {?}
     */
    GridBaseAPIService.prototype.remove_summary = /**
     * @param {?} id
     * @param {?=} name
     * @return {?}
     */
    function (id, name) {
        if (this.summaryCacheMap.has(id)) {
            if (!name) {
                this.summaryCacheMap.delete(id);
            }
            else {
                this.summaryCacheMap.get(id).delete(name);
            }
        }
    };
    /**
     * @param {?} gridId
     * @param {?} cell
     * @return {?}
     */
    GridBaseAPIService.prototype.set_cell_inEditMode = /**
     * @param {?} gridId
     * @param {?} cell
     * @return {?}
     */
    function (gridId, cell) {
        var /** @type {?} */ grid = this.get(gridId);
        var /** @type {?} */ args = {
            rowID: cell.cellID.rowID,
            cellID: cell.cellID,
            oldValue: cell.value,
            cancel: false
        };
        grid.onCellEditEnter.emit(args);
        if (args.cancel) {
            return;
        }
        if (grid.rowEditable) {
            var /** @type {?} */ currentEditRow = this.get_edit_row_state(gridId);
            if (currentEditRow && currentEditRow.rowID !== cell.cellID.rowID) {
                grid.endEdit(true);
                grid.startRowEdit(cell.cellID);
            }
            if (!currentEditRow) {
                grid.startRowEdit(cell.cellID);
            }
        }
        if (!this.get_cell_inEditMode(gridId)) {
            var /** @type {?} */ cellCopy = Object.assign({}, cell);
            cellCopy.row = Object.assign({}, cell.row);
            this.editCellState.set(gridId, { cellID: cell.cellID, cell: cellCopy });
        }
    };
    /**
     * @param {?} gridId
     * @param {?=} cellId
     * @return {?}
     */
    GridBaseAPIService.prototype.escape_editMode = /**
     * @param {?} gridId
     * @param {?=} cellId
     * @return {?}
     */
    function (gridId, cellId) {
        var /** @type {?} */ editableCell = this.get_cell_inEditMode(gridId);
        if (editableCell) {
            if (cellId) {
                if (cellId.rowID === editableCell.cellID.rowID &&
                    cellId.columnID === editableCell.cellID.columnID) {
                    this.editCellState.delete(gridId);
                }
            }
            else {
                var /** @type {?} */ grid = this.get(gridId);
                this.editCellState.delete(gridId);
            }
        }
        this.get(gridId).refreshSearch();
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    GridBaseAPIService.prototype.get_cell_inEditMode = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        var /** @type {?} */ editCellId = this.editCellState.get(gridId);
        if (editCellId) {
            return editCellId;
        }
        else {
            return null;
        }
    };
    /**
     * @param {?} id
     * @param {?} rowID
     * @return {?}
     */
    GridBaseAPIService.prototype.get_row_index_in_data = /**
     * @param {?} id
     * @param {?} rowID
     * @return {?}
     */
    function (id, rowID) {
        var /** @type {?} */ grid = /** @type {?} */ (this.get(id));
        if (!grid) {
            return -1;
        }
        var /** @type {?} */ data = this.get_all_data(id);
        return grid.primaryKey ? data.findIndex(function (record) { return record[grid.primaryKey] === rowID; }) : data.indexOf(rowID);
    };
    /**
     * @param {?} id
     * @param {?} rowSelector
     * @return {?}
     */
    GridBaseAPIService.prototype.get_row_by_key = /**
     * @param {?} id
     * @param {?} rowSelector
     * @return {?}
     */
    function (id, rowSelector) {
        var /** @type {?} */ primaryKey = this.get(id).primaryKey;
        if (primaryKey !== undefined && primaryKey !== null) {
            return this.get(id).dataRowList.find(function (row) { return row.rowData[primaryKey] === rowSelector; });
        }
        else {
            return this.get(id).dataRowList.find(function (row) { return row.rowData === rowSelector; });
        }
    };
    /**
     * @param {?} id
     * @param {?} rowIndex
     * @return {?}
     */
    GridBaseAPIService.prototype.get_row_by_index = /**
     * @param {?} id
     * @param {?} rowIndex
     * @return {?}
     */
    function (id, rowIndex) {
        return this.get(id).rowList.find(function (row) { return row.index === rowIndex; });
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    GridBaseAPIService.prototype.get_edit_row_state = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        var /** @type {?} */ editRow = this.editRowState.get(gridId);
        return editRow ? editRow : null;
    };
    /**
     * @param {?} gridId
     * @param {?} row
     * @return {?}
     */
    GridBaseAPIService.prototype.set_edit_row_state = /**
     * @param {?} gridId
     * @param {?} row
     * @return {?}
     */
    function (gridId, row) {
        if (!row) {
            this.editRowState.delete(gridId);
        }
        else {
            this.editRowState.set(gridId, row);
        }
    };
    /**
     * @param {?} id
     * @param {?} rowSelector
     * @param {?} field
     * @return {?}
     */
    GridBaseAPIService.prototype.get_cell_by_key = /**
     * @param {?} id
     * @param {?} rowSelector
     * @param {?} field
     * @return {?}
     */
    function (id, rowSelector, field) {
        var /** @type {?} */ row = this.get_row_by_key(id, rowSelector);
        if (row && row.cells) {
            return row.cells.find(function (cell) { return cell.column.field === field; });
        }
    };
    /**
     * @param {?} id
     * @param {?} rowIndex
     * @param {?} columnIndex
     * @return {?}
     */
    GridBaseAPIService.prototype.get_cell_by_index = /**
     * @param {?} id
     * @param {?} rowIndex
     * @param {?} columnIndex
     * @return {?}
     */
    function (id, rowIndex, columnIndex) {
        var /** @type {?} */ row = this.get_row_by_index(id, rowIndex);
        if (row && row.cells) {
            return row.cells.find(function (cell) { return cell.columnIndex === columnIndex; });
        }
    };
    /**
     * @param {?} id
     * @param {?} rowIndex
     * @param {?} columnIndex
     * @return {?}
     */
    GridBaseAPIService.prototype.get_cell_by_visible_index = /**
     * @param {?} id
     * @param {?} rowIndex
     * @param {?} columnIndex
     * @return {?}
     */
    function (id, rowIndex, columnIndex) {
        var /** @type {?} */ row = this.get_row_by_index(id, rowIndex);
        if (row && row.cells) {
            return row.cells.find(function (cell) { return cell.visibleColumnIndex === columnIndex; });
        }
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    GridBaseAPIService.prototype.submit_value = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        var /** @type {?} */ editableCell = this.get_cell_inEditMode(gridId);
        if (editableCell) {
            var /** @type {?} */ gridEditState = this.create_grid_edit_args(gridId, editableCell.cellID.rowID, editableCell.cellID.columnID, editableCell.cell.editValue);
            if (!editableCell.cell.column.inlineEditorTemplate && editableCell.cell.column.dataType === 'number') {
                if (!editableCell.cell.editValue) {
                    gridEditState.args.newValue = 0;
                    this.update_cell(gridId, editableCell.cellID.rowID, editableCell.cellID.columnID, 0, gridEditState);
                }
                else {
                    var /** @type {?} */ val = parseFloat(editableCell.cell.editValue);
                    if (!isNaN(val) || isFinite(val)) {
                        gridEditState.args.newValue = val;
                        this.update_cell(gridId, editableCell.cellID.rowID, editableCell.cellID.columnID, val, gridEditState);
                    }
                }
            }
            else {
                this.update_cell(gridId, editableCell.cellID.rowID, editableCell.cellID.columnID, editableCell.cell.editValue, gridEditState);
            }
            if (gridEditState.args.cancel) {
                return;
            }
            this.escape_editMode(gridId, editableCell.cellID);
        }
    };
    /**
     * @param {?} id
     * @param {?} rowID
     * @param {?} columnID
     * @param {?} editValue
     * @return {?}
     */
    GridBaseAPIService.prototype.create_grid_edit_args = /**
     * @param {?} id
     * @param {?} rowID
     * @param {?} columnID
     * @param {?} editValue
     * @return {?}
     */
    function (id, rowID, columnID, editValue) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ data = this.get_all_data(id);
        var /** @type {?} */ isRowSelected = grid.selection.is_item_selected(id, rowID);
        var /** @type {?} */ editableCell = this.get_cell_inEditMode(id);
        var /** @type {?} */ column = grid.columnList.toArray()[columnID];
        columnID = columnID !== undefined && columnID !== null ? columnID : null;
        var /** @type {?} */ cellObj;
        if (columnID !== null) {
            if ((editableCell && editableCell.cellID.rowID === rowID && editableCell.cellID.columnID === columnID)) {
                cellObj = editableCell;
            }
            else {
                cellObj = grid.columnList.toArray()[columnID].cells.find(function (cell) { return cell.cellID.rowID === rowID; });
            }
        }
        var /** @type {?} */ rowIndex = this.get_row_index_in_data(id, rowID);
        var /** @type {?} */ oldValue;
        var /** @type {?} */ rowData;
        if (rowIndex !== -1) {
            oldValue = columnID !== null ? data[rowIndex][column.field] : null;
            rowData = data[rowIndex];
        }
        //  if we have transactions and add row was edited look for old value and row data in added rows
        if (rowIndex < 0 && grid.transactions.enabled) {
            var /** @type {?} */ dataWithTransactions = grid.dataWithAddedInTransactionRows;
            rowIndex = grid.primaryKey ?
                dataWithTransactions.map(function (record) { return record[grid.primaryKey]; }).indexOf(rowID) :
                dataWithTransactions.indexOf(rowID);
            if (rowIndex !== -1) {
                //  Check if below change will work on added rows with transactions
                // oldValue = this.get_all_data(id, true)[rowIndex][column.field];
                // rowData = this.get_all_data(id, true)[rowIndex];
                oldValue = columnID !== null ? dataWithTransactions[rowIndex][column.field] : null;
                rowData = dataWithTransactions[rowIndex];
            }
        }
        var /** @type {?} */ args = {
            rowID: rowID,
            oldValue: oldValue,
            newValue: editValue,
            cancel: false
        };
        if (cellObj) {
            Object.assign(args, {
                cellID: cellObj.cellID
            });
        }
        return {
            args: args,
            isRowSelected: isRowSelected,
            rowData: rowData
        };
    };
    /**
     * @param {?} id
     * @param {?} rowID
     * @param {?} columnID
     * @param {?} editValue
     * @param {?=} gridEditState
     * @return {?}
     */
    GridBaseAPIService.prototype.update_cell = /**
     * @param {?} id
     * @param {?} rowID
     * @param {?} columnID
     * @param {?} editValue
     * @param {?=} gridEditState
     * @return {?}
     */
    function (id, rowID, columnID, editValue, gridEditState) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ data = this.get_all_data(id);
        var /** @type {?} */ currentGridEditState = gridEditState || this.create_grid_edit_args(id, rowID, columnID, editValue);
        var /** @type {?} */ emittedArgs = currentGridEditState.args;
        var /** @type {?} */ column = grid.columnList.toArray()[columnID];
        var /** @type {?} */ rowIndex = this.get_row_index_in_data(id, rowID);
        if (emittedArgs.oldValue !== undefined && currentGridEditState.rowData !== undefined) {
            grid.onCellEdit.emit(emittedArgs);
            if (emittedArgs.cancel) {
                return;
            }
            //  if we are editing the cell for second or next time, get the old value from transaction
            var /** @type {?} */ oldValueInTransaction = grid.transactions.getAggregatedValue(rowID, true);
            if (oldValueInTransaction) {
                emittedArgs.oldValue = oldValueInTransaction[column.field];
            }
            //  if edit (new) value is same as old value do nothing here
            if (emittedArgs.oldValue !== undefined
                && isEqual(emittedArgs.oldValue, emittedArgs.newValue)) {
                return;
            }
            var /** @type {?} */ transaction = {
                id: rowID, type: TransactionType.UPDATE, newValue: (_a = {}, _a[column.field] = emittedArgs.newValue, _a)
            };
            if (grid.transactions.enabled) {
                grid.transactions.add(transaction, currentGridEditState.rowData);
            }
            else {
                var /** @type {?} */ rowValue = this.get_all_data(id)[rowIndex];
                mergeObjects(rowValue, (_b = {}, _b[column.field] = emittedArgs.newValue, _b));
            }
            if (grid.primaryKey === column.field && currentGridEditState.isRowSelected) {
                grid.selection.deselect_item(id, rowID);
                grid.selection.select_item(id, emittedArgs.newValue);
            }
            if (!grid.rowEditable || !grid.rowInEditMode || grid.rowInEditMode.rowID !== rowID) {
                (/** @type {?} */ (grid))._pipeTrigger++;
            }
        }
        var _a, _b;
    };
    /**
     * @param {?} value
     * @param {?} id
     * @param {?} rowID
     * @param {?=} gridState
     * @return {?}
     */
    GridBaseAPIService.prototype.update_row = /**
     * @param {?} value
     * @param {?} id
     * @param {?} rowID
     * @param {?=} gridState
     * @return {?}
     */
    function (value, id, rowID, gridState) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ data = this.get_all_data(id);
        var /** @type {?} */ currentGridState = gridState ? gridState : this.create_grid_edit_args(id, rowID, null, value);
        var /** @type {?} */ emitArgs = currentGridState.args;
        var /** @type {?} */ index = this.get_row_index_in_data(id, rowID);
        var /** @type {?} */ currentRowInEditMode = this.get_edit_row_state(id);
        var /** @type {?} */ oldValue = Object.assign({}, data[index]);
        if (grid.currentRowState && grid.currentRowState[grid.primaryKey] === rowID
            || currentRowInEditMode && currentRowInEditMode.rowID === rowID) {
            oldValue = Object.assign(oldValue, grid.currentRowState);
        }
        else if (grid.transactions.enabled) {
            // If transactions are enabled, old value == last commited value (as it's not applied in data yet)
            var /** @type {?} */ lastCommitedValue = 
            // Last commited value (w/o pending)
            grid.transactions.getState(rowID) ? Object.assign({}, grid.transactions.getState(rowID).value) : null;
            oldValue = lastCommitedValue ? Object.assign(oldValue, lastCommitedValue) : oldValue;
        }
        Object.assign(emitArgs, { oldValue: oldValue, rowID: rowID });
        if (index !== -1) {
            grid.onRowEdit.emit(emitArgs);
            if (emitArgs.cancel) {
                return;
            }
            if (currentRowInEditMode) {
                grid.transactions.endPending(false);
            }
            if (grid.transactions.enabled && emitArgs.newValue !== null) {
                grid.transactions.add({ id: rowID, newValue: emitArgs.newValue, type: TransactionType.UPDATE }, emitArgs.oldValue);
            }
            else if (emitArgs.newValue !== null && emitArgs.newValue !== undefined) {
                Object.assign(data[index], emitArgs.newValue);
            }
            if (currentGridState.isRowSelected) {
                grid.selection.deselect_item(id, rowID);
                var /** @type {?} */ newRowID = (grid.primaryKey) ? emitArgs.newValue[grid.primaryKey] : emitArgs.newValue;
                grid.selection.select_item(id, newRowID);
            }
            (/** @type {?} */ (grid))._pipeTrigger++;
        }
    };
    /**
     * @param {?} id
     * @param {?} value
     * @param {?} rowID
     * @param {?} index
     * @return {?}
     */
    GridBaseAPIService.prototype.update_row_in_array = /**
     * @param {?} id
     * @param {?} value
     * @param {?} rowID
     * @param {?} index
     * @return {?}
     */
    function (id, value, rowID, index) {
        var /** @type {?} */ grid = this.get(id);
        grid.data[index] = value;
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @param {?} dir
     * @param {?} ignoreCase
     * @param {?} strategy
     * @return {?}
     */
    GridBaseAPIService.prototype.sort = /**
     * @param {?} id
     * @param {?} fieldName
     * @param {?} dir
     * @param {?} ignoreCase
     * @param {?} strategy
     * @return {?}
     */
    function (id, fieldName, dir, ignoreCase, strategy) {
        if (dir === SortingDirection.None) {
            this.remove_grouping_expression(id, fieldName);
        }
        var /** @type {?} */ sortingState = cloneArray(this.get(id).sortingExpressions);
        strategy = strategy ? strategy : this.getSortStrategyPerColumn(id, fieldName);
        this.prepare_sorting_expression([sortingState], { fieldName: fieldName, dir: dir, ignoreCase: ignoreCase, strategy: strategy });
        this.get(id).sortingExpressions = sortingState;
    };
    /**
     * @param {?} id
     * @param {?} expressions
     * @return {?}
     */
    GridBaseAPIService.prototype.sort_multiple = /**
     * @param {?} id
     * @param {?} expressions
     * @return {?}
     */
    function (id, expressions) {
        var /** @type {?} */ sortingState = cloneArray(this.get(id).sortingExpressions);
        try {
            for (var expressions_1 = tslib_1.__values(expressions), expressions_1_1 = expressions_1.next(); !expressions_1_1.done; expressions_1_1 = expressions_1.next()) {
                var each = expressions_1_1.value;
                if (each.dir === SortingDirection.None) {
                    this.remove_grouping_expression(id, each.fieldName);
                }
                each.strategy = each.strategy ? each.strategy : this.getSortStrategyPerColumn(id, each.fieldName);
                this.prepare_sorting_expression([sortingState], each);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (expressions_1_1 && !expressions_1_1.done && (_a = expressions_1.return)) _a.call(expressions_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.get(id).sortingExpressions = sortingState;
        var e_1, _a;
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @param {?} term
     * @param {?} conditionOrExpressionsTree
     * @param {?} ignoreCase
     * @return {?}
     */
    GridBaseAPIService.prototype.filter = /**
     * @param {?} id
     * @param {?} fieldName
     * @param {?} term
     * @param {?} conditionOrExpressionsTree
     * @param {?} ignoreCase
     * @return {?}
     */
    function (id, fieldName, term, conditionOrExpressionsTree, ignoreCase) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ filteringTree = grid.filteringExpressionsTree;
        grid.endEdit(false);
        if (grid.paging) {
            grid.page = 0;
        }
        var /** @type {?} */ fieldFilterIndex = filteringTree.findIndex(fieldName);
        if (fieldFilterIndex > -1) {
            filteringTree.filteringOperands.splice(fieldFilterIndex, 1);
        }
        this.prepare_filtering_expression(filteringTree, fieldName, term, conditionOrExpressionsTree, ignoreCase);
        grid.filteringExpressionsTree = filteringTree;
    };
    /**
     * @param {?} id
     * @param {?} term
     * @param {?} condition
     * @param {?} ignoreCase
     * @return {?}
     */
    GridBaseAPIService.prototype.filter_global = /**
     * @param {?} id
     * @param {?} term
     * @param {?} condition
     * @param {?} ignoreCase
     * @return {?}
     */
    function (id, term, condition, ignoreCase) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ filteringTree = grid.filteringExpressionsTree;
        if (grid.paging) {
            grid.page = 0;
        }
        filteringTree.filteringOperands = [];
        this.remove_summary(id);
        if (condition) {
            try {
                for (var _a = tslib_1.__values(grid.columns), _b = _a.next(); !_b.done; _b = _a.next()) {
                    var column = _b.value;
                    this.prepare_filtering_expression(filteringTree, column.field, term, condition, ignoreCase || column.filteringIgnoreCase);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
                }
                finally { if (e_2) throw e_2.error; }
            }
        }
        grid.filteringExpressionsTree = filteringTree;
        var e_2, _c;
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    GridBaseAPIService.prototype.clear_filter = /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    function (id, fieldName) {
        if (fieldName) {
            var /** @type {?} */ column = this.get_column_by_name(id, fieldName);
            if (!column) {
                return;
            }
        }
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ filteringState = grid.filteringExpressionsTree;
        var /** @type {?} */ index = filteringState.findIndex(fieldName);
        if (index > -1) {
            filteringState.filteringOperands.splice(index, 1);
            this.remove_summary(id, fieldName);
        }
        else {
            filteringState.filteringOperands = [];
            this.remove_summary(id);
        }
        grid.filteredData = null;
        grid.filteringExpressionsTree = filteringState;
    };
    /**
     * @param {?} id
     * @param {?} column
     * @param {?} data
     * @return {?}
     */
    GridBaseAPIService.prototype.calculateSummaries = /**
     * @param {?} id
     * @param {?} column
     * @param {?} data
     * @return {?}
     */
    function (id, column, data) {
        if (!this.summaryCacheMap.get(id).get(column.field)) {
            this.summaryCacheMap.get(id).set(column.field, column.summaries.operate(data));
        }
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    GridBaseAPIService.prototype.clear_sort = /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    function (id, fieldName) {
        var /** @type {?} */ sortingState = this.get(id).sortingExpressions;
        var /** @type {?} */ index = sortingState.findIndex(function (expr) { return expr.fieldName === fieldName; });
        if (index > -1) {
            sortingState.splice(index, 1);
            this.get(id).sortingExpressions = sortingState;
        }
    };
    /**
     * @param {?} filteringState
     * @param {?} fieldName
     * @param {?} searchVal
     * @param {?} conditionOrExpressionsTree
     * @param {?} ignoreCase
     * @return {?}
     */
    GridBaseAPIService.prototype.prepare_filtering_expression = /**
     * @param {?} filteringState
     * @param {?} fieldName
     * @param {?} searchVal
     * @param {?} conditionOrExpressionsTree
     * @param {?} ignoreCase
     * @return {?}
     */
    function (filteringState, fieldName, searchVal, conditionOrExpressionsTree, ignoreCase) {
        var /** @type {?} */ newExpressionsTree;
        var /** @type {?} */ oldExpressionsTreeIndex = filteringState.findIndex(fieldName);
        var /** @type {?} */ expressionsTree = conditionOrExpressionsTree instanceof FilteringExpressionsTree ? /** @type {?} */ (conditionOrExpressionsTree) : null;
        var /** @type {?} */ condition = conditionOrExpressionsTree instanceof FilteringExpressionsTree ?
            null : /** @type {?} */ (conditionOrExpressionsTree);
        var /** @type {?} */ newExpression = { fieldName: fieldName, searchVal: searchVal, condition: condition, ignoreCase: ignoreCase };
        if (oldExpressionsTreeIndex === -1) {
            // no expressions tree found for this field
            if (expressionsTree) {
                filteringState.filteringOperands.push(expressionsTree);
            }
            else if (condition) {
                // create expressions tree for this field and add the new expression to it
                newExpressionsTree = new FilteringExpressionsTree(filteringState.operator, fieldName);
                newExpressionsTree.filteringOperands.push(newExpression);
                filteringState.filteringOperands.push(newExpressionsTree);
            }
        }
    };
    /**
     * @param {?} stateCollections
     * @param {?} expression
     * @return {?}
     */
    GridBaseAPIService.prototype.prepare_sorting_expression = /**
     * @param {?} stateCollections
     * @param {?} expression
     * @return {?}
     */
    function (stateCollections, expression) {
        if (expression.dir === SortingDirection.None) {
            stateCollections.forEach(function (state) {
                state.splice(state.findIndex(function (expr) { return expr.fieldName === expression.fieldName; }), 1);
            });
            return;
        }
        /**
         * We need to make sure the states in each collection with same fields point to the same object reference.
         * If the different state collections provided have different sizes we need to get the largest one.
         * That way we can get the state reference from the largest one that has the same fieldName as the expression to prepare.
         */
        var /** @type {?} */ maxCollection = stateCollections[0];
        for (var /** @type {?} */ i = 1; i < stateCollections.length; i++) {
            if (maxCollection.length < stateCollections[i].length) {
                maxCollection = stateCollections[i];
            }
        }
        var /** @type {?} */ maxExpr = maxCollection.find(function (expr) { return expr.fieldName === expression.fieldName; });
        stateCollections.forEach(function (collection) {
            var /** @type {?} */ myExpr = collection.find(function (expr) { return expr.fieldName === expression.fieldName; });
            if (!myExpr && !maxExpr) {
                // Expression with this fieldName is missing from the current and the max collection.
                collection.push(expression);
            }
            else if (!myExpr && maxExpr) {
                // Expression with this fieldName is missing from the current and but the max collection has.
                collection.push(maxExpr);
                Object.assign(maxExpr, expression);
            }
            else {
                // The current collection has the expression so just update it.
                Object.assign(myExpr, expression);
            }
        });
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    GridBaseAPIService.prototype.remove_grouping_expression = /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    function (id, fieldName) {
    };
    /**
     * @param {?} column
     * @return {?}
     */
    GridBaseAPIService.prototype.should_apply_number_style = /**
     * @param {?} column
     * @return {?}
     */
    function (column) {
        return column.dataType === DataType.Number;
    };
    /**
     * @param {?} id
     * @param {?=} transactions
     * @return {?}
     */
    GridBaseAPIService.prototype.get_all_data = /**
     * @param {?} id
     * @param {?=} transactions
     * @return {?}
     */
    function (id, transactions) {
        var /** @type {?} */ grid = this.get(id);
        var /** @type {?} */ data = transactions ? grid.dataWithAddedInTransactionRows : grid.data;
        return data ? data : [];
    };
    /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    GridBaseAPIService.prototype.getSortStrategyPerColumn = /**
     * @param {?} id
     * @param {?} fieldName
     * @return {?}
     */
    function (id, fieldName) {
        return this.get_column_by_name(this.get(id).id, fieldName) ?
            this.get_column_by_name(id, fieldName).sortStrategy : undefined;
    };
    GridBaseAPIService.decorators = [
        { type: Injectable },
    ];
    return GridBaseAPIService;
}());
export { GridBaseAPIService };
function GridBaseAPIService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    GridBaseAPIService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    GridBaseAPIService.ctorParameters;
    /** @type {?} */
    GridBaseAPIService.prototype.change;
    /** @type {?} */
    GridBaseAPIService.prototype.state;
    /** @type {?} */
    GridBaseAPIService.prototype.editCellState;
    /** @type {?} */
    GridBaseAPIService.prototype.editRowState;
    /** @type {?} */
    GridBaseAPIService.prototype.summaryCacheMap;
    /** @type {?} */
    GridBaseAPIService.prototype.destroyMap;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9pZ25pdGV1aS1hbmd1bGFyLyIsInNvdXJjZXMiOlsibGliL2dyaWRzL2FwaS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBSWxFLE9BQU8sRUFBc0IsZ0JBQWdCLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQU12RyxPQUFPLEVBQTZCLHdCQUF3QixFQUFFLE1BQU0sK0NBQStDLENBQUM7QUFDcEgsT0FBTyxFQUFlLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7Ozs7OztzQkFTL0IsSUFBSSxPQUFPLEVBQU87cUJBQ2QsSUFBSSxHQUFHLEVBQWE7NkJBQ1YsSUFBSSxHQUFHLEVBQWU7NEJBQ00sSUFBSSxHQUFHLEVBQUU7K0JBQ3BCLElBQUksR0FBRyxFQUE4QjswQkFDNUMsSUFBSSxHQUFHLEVBQTRCOzs7Ozs7SUFFbEYscUNBQVE7Ozs7Y0FBQyxJQUFPO1FBQ25CLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLE9BQU8sRUFBVyxDQUFDLENBQUM7Ozs7OztJQUdsRCx3Q0FBVzs7OztjQUFDLElBQU87UUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDOzs7Ozs7SUFHeEIsZ0NBQUc7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Q0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0tBQ3ZFOztnQkE5a0JKLFVBQVU7OzZCQXBCWDs7U0FxQmEsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2xvbmVBcnJheSwgaXNFcXVhbCwgbWVyZ2VPYmplY3RzIH0gZnJvbSAnLi4vY29yZS91dGlscyc7XG5pbXBvcnQgeyBEYXRhVXRpbCwgRGF0YVR5cGUgfSBmcm9tICcuLi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsJztcbmltcG9ydCB7IElGaWx0ZXJpbmdFeHByZXNzaW9uLCBGaWx0ZXJpbmdMb2dpYyB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9maWx0ZXJpbmctZXhwcmVzc2lvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSUdyb3VwQnlFeHBhbmRTdGF0ZSB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9ncm91cGJ5LWV4cGFuZC1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSUdyb3VwQnlSZWNvcmQgfSBmcm9tICcuLi9kYXRhLW9wZXJhdGlvbnMvZ3JvdXBieS1yZWNvcmQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElTb3J0aW5nRXhwcmVzc2lvbiwgU29ydGluZ0RpcmVjdGlvbiB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9zb3J0aW5nLWV4cHJlc3Npb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IElneEdyaWRDZWxsQ29tcG9uZW50IH0gZnJvbSAnLi9jZWxsLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJZ3hDb2x1bW5Db21wb25lbnQgfSBmcm9tICcuL2NvbHVtbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgSUdyaWRFZGl0RXZlbnRBcmdzLCBJZ3hHcmlkQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vZ3JpZC1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJZ3hSb3dDb21wb25lbnQgfSBmcm9tICcuL3Jvdy5jb21wb25lbnQnO1xuaW1wb3J0IHsgSUZpbHRlcmluZ09wZXJhdGlvbiB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9maWx0ZXJpbmctY29uZGl0aW9uJztcbmltcG9ydCB7IElGaWx0ZXJpbmdFeHByZXNzaW9uc1RyZWUsIEZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9maWx0ZXJpbmctZXhwcmVzc2lvbnMtdHJlZSc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvbiwgVHJhbnNhY3Rpb25UeXBlIH0gZnJvbSAnLi4vc2VydmljZXMvaW5kZXgnO1xuaW1wb3J0IHsgSVNvcnRpbmdTdHJhdGVneSB9IGZyb20gJy4uL2RhdGEtb3BlcmF0aW9ucy9zb3J0aW5nLXN0cmF0ZWd5JztcbmltcG9ydCB7IFNvcnRpbmdTdGF0ZURlZmF1bHRzIH0gZnJvbSAnLi4vZGF0YS1vcGVyYXRpb25zL3NvcnRpbmctc3RhdGUuaW50ZXJmYWNlJztcbi8qKlxuICpAaGlkZGVuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHcmlkQmFzZUFQSVNlcnZpY2UgPFQgZXh0ZW5kcyBJZ3hHcmlkQmFzZUNvbXBvbmVudD4ge1xuXG4gICAgcHVibGljIGNoYW5nZTogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIHByb3RlY3RlZCBzdGF0ZTogTWFwPHN0cmluZywgVD4gPSBuZXcgTWFwPHN0cmluZywgVD4oKTtcbiAgICBwcm90ZWN0ZWQgZWRpdENlbGxTdGF0ZTogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgcHJvdGVjdGVkIGVkaXRSb3dTdGF0ZTogTWFwPHN0cmluZywgeyByb3dJRDogYW55LCByb3dJbmRleDogbnVtYmVyIH0+ID0gbmV3IE1hcCgpO1xuICAgIHByb3RlY3RlZCBzdW1tYXJ5Q2FjaGVNYXA6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIGFueVtdPj4gPSBuZXcgTWFwPHN0cmluZywgTWFwPHN0cmluZywgYW55W10+PigpO1xuICAgIHByb3RlY3RlZCBkZXN0cm95TWFwOiBNYXA8c3RyaW5nLCBTdWJqZWN0PGJvb2xlYW4+PiA9IG5ldyBNYXA8c3RyaW5nLCBTdWJqZWN0PGJvb2xlYW4+PigpO1xuXG4gICAgcHVibGljIHJlZ2lzdGVyKGdyaWQ6IFQpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5zZXQoZ3JpZC5pZCwgZ3JpZCk7XG4gICAgICAgIHRoaXMuZGVzdHJveU1hcC5zZXQoZ3JpZC5pZCwgbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVuc3Vic2NyaWJlKGdyaWQ6IFQpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5kZWxldGUoZ3JpZC5pZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldChpZDogc3RyaW5nKTogVCB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChpZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVuc2V0KGlkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5kZWxldGUoaWQpO1xuICAgICAgICB0aGlzLnN1bW1hcnlDYWNoZU1hcC5kZWxldGUoaWQpO1xuICAgICAgICB0aGlzLmVkaXRDZWxsU3RhdGUuZGVsZXRlKGlkKTtcbiAgICAgICAgdGhpcy5lZGl0Um93U3RhdGUuZGVsZXRlKGlkKTtcbiAgICAgICAgdGhpcy5kZXN0cm95TWFwLmRlbGV0ZShpZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc2V0KG9sZElkOiBzdHJpbmcsIG5ld0lkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZGVzdHJveSA9IHRoaXMuZGVzdHJveU1hcC5nZXQob2xkSWQpO1xuICAgICAgICBjb25zdCBzdW1tYXJ5ID0gdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZ2V0KG9sZElkKTtcbiAgICAgICAgY29uc3QgZWRpdENlbGxTdGF0ZSA9IHRoaXMuZWRpdENlbGxTdGF0ZS5nZXQob2xkSWQpO1xuICAgICAgICBjb25zdCBlZGl0Um93U3RhdGUgPSB0aGlzLmVkaXRSb3dTdGF0ZS5nZXQob2xkSWQpO1xuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQob2xkSWQpO1xuXG4gICAgICAgIHRoaXMudW5zZXQob2xkSWQpO1xuXG4gICAgICAgIGlmIChncmlkKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnNldChuZXdJZCwgZ3JpZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGVzdHJveSkge1xuICAgICAgICAgICAgdGhpcy5kZXN0cm95TWFwLnNldChuZXdJZCwgZGVzdHJveSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc3VtbWFyeSkge1xuICAgICAgICAgICAgdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuc2V0KG5ld0lkLCBzdW1tYXJ5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlZGl0Q2VsbFN0YXRlKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRDZWxsU3RhdGUuc2V0KG5ld0lkLCBlZGl0Q2VsbFN0YXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlZGl0Um93U3RhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdFJvd1N0YXRlLnNldChuZXdJZCwgZWRpdFJvd1N0YXRlKTtcbiAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9jb2x1bW5fYnlfbmFtZShpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcpOiBJZ3hDb2x1bW5Db21wb25lbnQge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXQoaWQpLmNvbHVtbkxpc3QuZmluZCgoY29sKSA9PiBjb2wuZmllbGQgPT09IG5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRfc3VtbWFyeV9ieV9jb2x1bW5fbmFtZShpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN1bW1hcnlDYWNoZU1hcC5nZXQoaWQpKSB7XG4gICAgICAgICAgICB0aGlzLnN1bW1hcnlDYWNoZU1hcC5zZXQoaWQsIG5ldyBNYXA8c3RyaW5nLCBhbnlbXT4oKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29sdW1uID0gdGhpcy5nZXRfY29sdW1uX2J5X25hbWUoaWQsIG5hbWUpO1xuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQoaWQpO1xuICAgICAgICBsZXQgZGF0YSA9IGdyaWQuZmlsdGVyZWREYXRhO1xuICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICAgIGlmIChncmlkLnRyYW5zYWN0aW9ucy5lbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IERhdGFVdGlsLm1lcmdlVHJhbnNhY3Rpb25zKFxuICAgICAgICAgICAgICAgICAgICBjbG9uZUFycmF5KGdyaWQuZGF0YSksXG4gICAgICAgICAgICAgICAgICAgIGdyaWQudHJhbnNhY3Rpb25zLmdldEFnZ3JlZ2F0ZWRDaGFuZ2VzKHRydWUpLFxuICAgICAgICAgICAgICAgICAgICBncmlkLnByaW1hcnlLZXlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkYXRhID0gZ3JpZC5kYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBjb25zdCBjb2x1bW5WYWx1ZXMgPSBkYXRhLm1hcCgocmVjKSA9PiByZWNbY29sdW1uLmZpZWxkXSk7XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVN1bW1hcmllcyhpZCwgY29sdW1uLCBjb2x1bW5WYWx1ZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9zdW1tYXJpZXMoaWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZ2V0KGlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVtb3ZlX3N1bW1hcnkoaWQ6IHN0cmluZywgbmFtZT86IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5zdW1tYXJ5Q2FjaGVNYXAuaGFzKGlkKSkge1xuICAgICAgICAgICAgaWYgKCFuYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZGVsZXRlKGlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZ2V0KGlkKS5kZWxldGUobmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0X2NlbGxfaW5FZGl0TW9kZShncmlkSWQ6IHN0cmluZywgY2VsbDogSWd4R3JpZENlbGxDb21wb25lbnQpIHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0KGdyaWRJZCk7XG4gICAgICAgIGNvbnN0IGFyZ3M6IElHcmlkRWRpdEV2ZW50QXJncyA9IHtcbiAgICAgICAgICAgIHJvd0lEOiBjZWxsLmNlbGxJRC5yb3dJRCxcbiAgICAgICAgICAgIGNlbGxJRDogY2VsbC5jZWxsSUQsXG4gICAgICAgICAgICBvbGRWYWx1ZTogY2VsbC52YWx1ZSxcbiAgICAgICAgICAgIGNhbmNlbDogZmFsc2VcbiAgICAgICAgfTtcbiAgICAgICAgZ3JpZC5vbkNlbGxFZGl0RW50ZXIuZW1pdChhcmdzKTtcbiAgICAgICAgaWYgKGFyZ3MuY2FuY2VsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGdyaWQucm93RWRpdGFibGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRFZGl0Um93ID0gdGhpcy5nZXRfZWRpdF9yb3dfc3RhdGUoZ3JpZElkKTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50RWRpdFJvdyAmJiBjdXJyZW50RWRpdFJvdy5yb3dJRCAhPT0gY2VsbC5jZWxsSUQucm93SUQpIHtcbiAgICAgICAgICAgICAgICBncmlkLmVuZEVkaXQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgZ3JpZC5zdGFydFJvd0VkaXQoY2VsbC5jZWxsSUQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFjdXJyZW50RWRpdFJvdykge1xuICAgICAgICAgICAgICAgIGdyaWQuc3RhcnRSb3dFZGl0KGNlbGwuY2VsbElEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5nZXRfY2VsbF9pbkVkaXRNb2RlKGdyaWRJZCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNlbGxDb3B5ID0gT2JqZWN0LmFzc2lnbih7fSwgY2VsbCk7XG4gICAgICAgICAgICBjZWxsQ29weS5yb3cgPSBPYmplY3QuYXNzaWduKHt9LCBjZWxsLnJvdyk7XG4gICAgICAgIHRoaXMuZWRpdENlbGxTdGF0ZS5zZXQoZ3JpZElkLCB7IGNlbGxJRDogY2VsbC5jZWxsSUQsIGNlbGw6IGNlbGxDb3B5IH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGVzY2FwZV9lZGl0TW9kZShncmlkSWQsIGNlbGxJZD8pIHtcbiAgICAgICAgY29uc3QgZWRpdGFibGVDZWxsID0gdGhpcy5nZXRfY2VsbF9pbkVkaXRNb2RlKGdyaWRJZCk7XG4gICAgICAgIGlmIChlZGl0YWJsZUNlbGwpIHtcbiAgICAgICAgICAgIGlmIChjZWxsSWQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2VsbElkLnJvd0lEID09PSBlZGl0YWJsZUNlbGwuY2VsbElELnJvd0lEICYmXG4gICAgICAgICAgICAgICAgICAgIGNlbGxJZC5jb2x1bW5JRCA9PT0gZWRpdGFibGVDZWxsLmNlbGxJRC5jb2x1bW5JRCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRDZWxsU3RhdGUuZGVsZXRlKGdyaWRJZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQoZ3JpZElkKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRDZWxsU3RhdGUuZGVsZXRlKGdyaWRJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdldChncmlkSWQpLnJlZnJlc2hTZWFyY2goKTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBnZXRfY2VsbF9pbkVkaXRNb2RlKGdyaWRJZCk6IHtcbiAgICAgICAgY2VsbElEOiB7XG4gICAgICAgICAgICByb3dJRDogYW55LFxuICAgICAgICAgICAgY29sdW1uSUQ6IG51bWJlcixcbiAgICAgICAgICAgIHJvd0luZGV4OiBudW1iZXJcbiAgICAgICAgfSxcbiAgICAgICAgY2VsbDogYW55XG4gICAgfSB7XG4gICAgICAgIGNvbnN0IGVkaXRDZWxsSWQgPSB0aGlzLmVkaXRDZWxsU3RhdGUuZ2V0KGdyaWRJZCk7XG4gICAgICAgIGlmIChlZGl0Q2VsbElkKSB7XG4gICAgICAgICAgICByZXR1cm4gZWRpdENlbGxJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9yb3dfaW5kZXhfaW5fZGF0YShpZDogc3RyaW5nLCByb3dJRDogYW55KTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0KGlkKSBhcyBJZ3hHcmlkQmFzZUNvbXBvbmVudDtcbiAgICAgICAgaWYgKCFncmlkKSB7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkKTtcbiAgICAgICAgcmV0dXJuIGdyaWQucHJpbWFyeUtleSA/IGRhdGEuZmluZEluZGV4KHJlY29yZCA9PiByZWNvcmRbZ3JpZC5wcmltYXJ5S2V5XSA9PT0gcm93SUQpIDogZGF0YS5pbmRleE9mKHJvd0lEKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0X3Jvd19ieV9rZXkoaWQ6IHN0cmluZywgcm93U2VsZWN0b3I6IGFueSk6IElneFJvd0NvbXBvbmVudDxJZ3hHcmlkQmFzZUNvbXBvbmVudD4ge1xuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0gdGhpcy5nZXQoaWQpLnByaW1hcnlLZXk7XG4gICAgICAgIGlmIChwcmltYXJ5S2V5ICE9PSB1bmRlZmluZWQgJiYgcHJpbWFyeUtleSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGlkKS5kYXRhUm93TGlzdC5maW5kKChyb3cpID0+IHJvdy5yb3dEYXRhW3ByaW1hcnlLZXldID09PSByb3dTZWxlY3Rvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoaWQpLmRhdGFSb3dMaXN0LmZpbmQoKHJvdykgPT4gcm93LnJvd0RhdGEgPT09IHJvd1NlbGVjdG9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRfcm93X2J5X2luZGV4KGlkOiBzdHJpbmcsIHJvd0luZGV4OiBudW1iZXIpOiBJZ3hSb3dDb21wb25lbnQ8SWd4R3JpZEJhc2VDb21wb25lbnQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGlkKS5yb3dMaXN0LmZpbmQoKHJvdykgPT4gcm93LmluZGV4ID09PSByb3dJbmRleCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9lZGl0X3Jvd19zdGF0ZShncmlkSWQpOiB7XG4gICAgICAgIHJvd0lEOiBhbnksXG4gICAgICAgIHJvd0luZGV4OiBudW1iZXJcbiAgICB9IHtcbiAgICAgICAgY29uc3QgZWRpdFJvdyA9IHRoaXMuZWRpdFJvd1N0YXRlLmdldChncmlkSWQpO1xuICAgICAgICByZXR1cm4gZWRpdFJvdyA/IGVkaXRSb3cgOiBudWxsO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHNldF9lZGl0X3Jvd19zdGF0ZShncmlkSWQsIHJvdzogeyByb3dJRDogYW55LCByb3dJbmRleDogbnVtYmVyIH0pIHtcbiAgICAgICAgaWYgKCFyb3cpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdFJvd1N0YXRlLmRlbGV0ZShncmlkSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5lZGl0Um93U3RhdGUuc2V0KGdyaWRJZCwgcm93KTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHVibGljIGdldF9jZWxsX2J5X2tleShpZDogc3RyaW5nLCByb3dTZWxlY3RvcjogYW55LCBmaWVsZDogc3RyaW5nKTogSWd4R3JpZENlbGxDb21wb25lbnQge1xuICAgICAgICBjb25zdCByb3cgPSB0aGlzLmdldF9yb3dfYnlfa2V5KGlkLCByb3dTZWxlY3Rvcik7XG4gICAgICAgIGlmIChyb3cgJiYgcm93LmNlbGxzKSB7XG4gICAgICAgICAgICByZXR1cm4gcm93LmNlbGxzLmZpbmQoKGNlbGwpID0+IGNlbGwuY29sdW1uLmZpZWxkID09PSBmaWVsZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0X2NlbGxfYnlfaW5kZXgoaWQ6IHN0cmluZywgcm93SW5kZXg6IG51bWJlciwgY29sdW1uSW5kZXg6IG51bWJlcik6IElneEdyaWRDZWxsQ29tcG9uZW50IHtcbiAgICAgICAgY29uc3Qgcm93ID0gdGhpcy5nZXRfcm93X2J5X2luZGV4KGlkLCByb3dJbmRleCk7XG4gICAgICAgIGlmIChyb3cgJiYgcm93LmNlbGxzKSB7XG4gICAgICAgICAgICByZXR1cm4gcm93LmNlbGxzLmZpbmQoKGNlbGwpID0+IGNlbGwuY29sdW1uSW5kZXggPT09IGNvbHVtbkluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRfY2VsbF9ieV92aXNpYmxlX2luZGV4KGlkOiBzdHJpbmcsIHJvd0luZGV4OiBudW1iZXIsIGNvbHVtbkluZGV4OiBudW1iZXIpOiBJZ3hHcmlkQ2VsbENvbXBvbmVudCB7XG4gICAgICAgIGNvbnN0IHJvdyA9IHRoaXMuZ2V0X3Jvd19ieV9pbmRleChpZCwgcm93SW5kZXgpO1xuICAgICAgICBpZiAocm93ICYmIHJvdy5jZWxscykge1xuICAgICAgICAgICAgcmV0dXJuIHJvdy5jZWxscy5maW5kKChjZWxsKSA9PiBjZWxsLnZpc2libGVDb2x1bW5JbmRleCA9PT0gY29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN1Ym1pdF92YWx1ZShncmlkSWQpIHtcbiAgICAgICAgY29uc3QgZWRpdGFibGVDZWxsID0gdGhpcy5nZXRfY2VsbF9pbkVkaXRNb2RlKGdyaWRJZCk7XG4gICAgICAgIGlmIChlZGl0YWJsZUNlbGwpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyaWRFZGl0U3RhdGUgPSB0aGlzLmNyZWF0ZV9ncmlkX2VkaXRfYXJncyhncmlkSWQsIGVkaXRhYmxlQ2VsbC5jZWxsSUQucm93SUQsXG4gICAgICAgICAgICAgICAgZWRpdGFibGVDZWxsLmNlbGxJRC5jb2x1bW5JRCwgZWRpdGFibGVDZWxsLmNlbGwuZWRpdFZhbHVlKTtcbiAgICAgICAgICAgIGlmICghZWRpdGFibGVDZWxsLmNlbGwuY29sdW1uLmlubGluZUVkaXRvclRlbXBsYXRlICYmIGVkaXRhYmxlQ2VsbC5jZWxsLmNvbHVtbi5kYXRhVHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWVkaXRhYmxlQ2VsbC5jZWxsLmVkaXRWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBncmlkRWRpdFN0YXRlLmFyZ3MubmV3VmFsdWUgPSAwO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9jZWxsKGdyaWRJZCwgZWRpdGFibGVDZWxsLmNlbGxJRC5yb3dJRCwgZWRpdGFibGVDZWxsLmNlbGxJRC5jb2x1bW5JRCwgMCwgZ3JpZEVkaXRTdGF0ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsID0gcGFyc2VGbG9hdChlZGl0YWJsZUNlbGwuY2VsbC5lZGl0VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbCkgfHwgaXNGaW5pdGUodmFsKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZEVkaXRTdGF0ZS5hcmdzLm5ld1ZhbHVlID0gdmFsO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVfY2VsbChncmlkSWQsIGVkaXRhYmxlQ2VsbC5jZWxsSUQucm93SUQsIGVkaXRhYmxlQ2VsbC5jZWxsSUQuY29sdW1uSUQsIHZhbCwgZ3JpZEVkaXRTdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlX2NlbGwoZ3JpZElkLCBlZGl0YWJsZUNlbGwuY2VsbElELnJvd0lELCBlZGl0YWJsZUNlbGwuY2VsbElELmNvbHVtbklELFxuICAgICAgICAgICAgICAgICAgICBlZGl0YWJsZUNlbGwuY2VsbC5lZGl0VmFsdWUsIGdyaWRFZGl0U3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGdyaWRFZGl0U3RhdGUuYXJncy5jYW5jZWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmVzY2FwZV9lZGl0TW9kZShncmlkSWQsIGVkaXRhYmxlQ2VsbC5jZWxsSUQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZV9ncmlkX2VkaXRfYXJncyhpZDogc3RyaW5nLCByb3dJRCwgY29sdW1uSUQsIGVkaXRWYWx1ZSk6IHtcbiAgICAgICAgYXJnczogSUdyaWRFZGl0RXZlbnRBcmdzLFxuICAgICAgICBpc1Jvd1NlbGVjdGVkOiBib29sZWFuLFxuICAgICAgICByb3dEYXRhOiBhbnlcbiAgICB9IHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0KGlkKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkKTtcbiAgICAgICAgY29uc3QgaXNSb3dTZWxlY3RlZCA9IGdyaWQuc2VsZWN0aW9uLmlzX2l0ZW1fc2VsZWN0ZWQoaWQsIHJvd0lEKTtcbiAgICAgICAgY29uc3QgZWRpdGFibGVDZWxsID0gdGhpcy5nZXRfY2VsbF9pbkVkaXRNb2RlKGlkKTtcbiAgICAgICAgY29uc3QgY29sdW1uID0gZ3JpZC5jb2x1bW5MaXN0LnRvQXJyYXkoKVtjb2x1bW5JRF07XG4gICAgICAgIGNvbHVtbklEID0gY29sdW1uSUQgIT09IHVuZGVmaW5lZCAmJiBjb2x1bW5JRCAhPT0gbnVsbCA/IGNvbHVtbklEIDogbnVsbDtcbiAgICAgICAgbGV0IGNlbGxPYmo7XG4gICAgICAgIGlmIChjb2x1bW5JRCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWYgKChlZGl0YWJsZUNlbGwgJiYgZWRpdGFibGVDZWxsLmNlbGxJRC5yb3dJRCA9PT0gcm93SUQgJiYgZWRpdGFibGVDZWxsLmNlbGxJRC5jb2x1bW5JRCA9PT0gY29sdW1uSUQpKSB7XG4gICAgICAgICAgICAgICAgY2VsbE9iaiA9IGVkaXRhYmxlQ2VsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2VsbE9iaiA9IGdyaWQuY29sdW1uTGlzdC50b0FycmF5KClbY29sdW1uSURdLmNlbGxzLmZpbmQoKGNlbGwpID0+IGNlbGwuY2VsbElELnJvd0lEID09PSByb3dJRCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJvd0luZGV4ID0gdGhpcy5nZXRfcm93X2luZGV4X2luX2RhdGEoaWQsIHJvd0lEKTtcbiAgICAgICAgbGV0IG9sZFZhbHVlOiBhbnk7XG4gICAgICAgIGxldCByb3dEYXRhOiBhbnk7XG4gICAgICAgIGlmIChyb3dJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIG9sZFZhbHVlID0gY29sdW1uSUQgIT09IG51bGwgPyBkYXRhW3Jvd0luZGV4XVtjb2x1bW4uZmllbGRdIDogbnVsbDtcbiAgICAgICAgICAgIHJvd0RhdGEgPSBkYXRhW3Jvd0luZGV4XTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vICBpZiB3ZSBoYXZlIHRyYW5zYWN0aW9ucyBhbmQgYWRkIHJvdyB3YXMgZWRpdGVkIGxvb2sgZm9yIG9sZCB2YWx1ZSBhbmQgcm93IGRhdGEgaW4gYWRkZWQgcm93c1xuICAgICAgICBpZiAocm93SW5kZXggPCAwICYmIGdyaWQudHJhbnNhY3Rpb25zLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGFXaXRoVHJhbnNhY3Rpb25zID0gZ3JpZC5kYXRhV2l0aEFkZGVkSW5UcmFuc2FjdGlvblJvd3M7XG4gICAgICAgICAgICByb3dJbmRleCA9IGdyaWQucHJpbWFyeUtleSA/XG4gICAgICAgICAgICBkYXRhV2l0aFRyYW5zYWN0aW9ucy5tYXAoKHJlY29yZCkgPT4gcmVjb3JkW2dyaWQucHJpbWFyeUtleV0pLmluZGV4T2Yocm93SUQpIDpcbiAgICAgICAgICAgIGRhdGFXaXRoVHJhbnNhY3Rpb25zLmluZGV4T2Yocm93SUQpO1xuICAgICAgICAgICAgaWYgKHJvd0luZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiBiZWxvdyBjaGFuZ2Ugd2lsbCB3b3JrIG9uIGFkZGVkIHJvd3Mgd2l0aCB0cmFuc2FjdGlvbnNcbiAgICAgICAgICAgICAgICAvLyBvbGRWYWx1ZSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkLCB0cnVlKVtyb3dJbmRleF1bY29sdW1uLmZpZWxkXTtcbiAgICAgICAgICAgICAgICAvLyByb3dEYXRhID0gdGhpcy5nZXRfYWxsX2RhdGEoaWQsIHRydWUpW3Jvd0luZGV4XTtcbiAgICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGNvbHVtbklEICE9PSBudWxsID8gZGF0YVdpdGhUcmFuc2FjdGlvbnNbcm93SW5kZXhdW2NvbHVtbi5maWVsZF0gOiBudWxsO1xuICAgICAgICAgICAgICAgIHJvd0RhdGEgPSBkYXRhV2l0aFRyYW5zYWN0aW9uc1tyb3dJbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXJncyA9IHtcbiAgICAgICAgICAgIHJvd0lELFxuICAgICAgICAgICAgICAgIG9sZFZhbHVlOiBvbGRWYWx1ZSxcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZTogZWRpdFZhbHVlLFxuICAgICAgICAgICAgICAgIGNhbmNlbDogZmFsc2VcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGNlbGxPYmopIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oYXJncywge1xuICAgICAgICAgICAgICAgIGNlbGxJRDogY2VsbE9iai5jZWxsSURcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhcmdzLFxuICAgICAgICAgICAgaXNSb3dTZWxlY3RlZCxcbiAgICAgICAgICAgIHJvd0RhdGFcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyAgVE9ETzogcmVmYWN0b3IgdXBkYXRlX2NlbGwuIE1heWJlIHNlcGFyYXRlIGxvZ2ljIGluIHR3byBtZXRob2RzIC0gb25lIHdpdGggdHJhbnNhY3Rpb25cbiAgICAvLyAgYW5kIG9uZSB3aXRob3V0IHRyYW5zYWN0aW9uXG4gICAgcHVibGljIHVwZGF0ZV9jZWxsKGlkOiBzdHJpbmcsIHJvd0lELCBjb2x1bW5JRCwgZWRpdFZhbHVlLCBncmlkRWRpdFN0YXRlPzoge1xuICAgICAgICBhcmdzOiBJR3JpZEVkaXRFdmVudEFyZ3MsXG4gICAgICAgIGlzUm93U2VsZWN0ZWQ6IGJvb2xlYW4sXG4gICAgICAgIHJvd0RhdGE6IGFueVxuICAgIH0pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0KGlkKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkKTtcbiAgICAgICAgY29uc3QgY3VycmVudEdyaWRFZGl0U3RhdGUgPSBncmlkRWRpdFN0YXRlIHx8IHRoaXMuY3JlYXRlX2dyaWRfZWRpdF9hcmdzKGlkLCByb3dJRCwgY29sdW1uSUQsIGVkaXRWYWx1ZSk7XG4gICAgICAgIGNvbnN0IGVtaXR0ZWRBcmdzID0gY3VycmVudEdyaWRFZGl0U3RhdGUuYXJncztcbiAgICAgICAgY29uc3QgY29sdW1uID0gZ3JpZC5jb2x1bW5MaXN0LnRvQXJyYXkoKVtjb2x1bW5JRF07XG4gICAgICAgIGNvbnN0IHJvd0luZGV4ID0gdGhpcy5nZXRfcm93X2luZGV4X2luX2RhdGEoaWQsIHJvd0lEKTtcblxuICAgICAgICBpZiAoZW1pdHRlZEFyZ3Mub2xkVmFsdWUgIT09IHVuZGVmaW5lZCAmJiBjdXJyZW50R3JpZEVkaXRTdGF0ZS5yb3dEYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGdyaWQub25DZWxsRWRpdC5lbWl0KGVtaXR0ZWRBcmdzKTtcbiAgICAgICAgICAgIGlmIChlbWl0dGVkQXJncy5jYW5jZWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyAgaWYgd2UgYXJlIGVkaXRpbmcgdGhlIGNlbGwgZm9yIHNlY29uZCBvciBuZXh0IHRpbWUsIGdldCB0aGUgb2xkIHZhbHVlIGZyb20gdHJhbnNhY3Rpb25cbiAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlSW5UcmFuc2FjdGlvbiA9IGdyaWQudHJhbnNhY3Rpb25zLmdldEFnZ3JlZ2F0ZWRWYWx1ZShyb3dJRCwgdHJ1ZSk7XG4gICAgICAgICAgICBpZiAob2xkVmFsdWVJblRyYW5zYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgZW1pdHRlZEFyZ3Mub2xkVmFsdWUgPSBvbGRWYWx1ZUluVHJhbnNhY3Rpb25bY29sdW1uLmZpZWxkXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gIGlmIGVkaXQgKG5ldykgdmFsdWUgaXMgc2FtZSBhcyBvbGQgdmFsdWUgZG8gbm90aGluZyBoZXJlXG4gICAgICAgICAgICBpZiAoZW1pdHRlZEFyZ3Mub2xkVmFsdWUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIGlzRXF1YWwoZW1pdHRlZEFyZ3Mub2xkVmFsdWUsIGVtaXR0ZWRBcmdzLm5ld1ZhbHVlKSkgeyByZXR1cm47IH1cbiAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICBpZDogcm93SUQsIHR5cGU6IFRyYW5zYWN0aW9uVHlwZS5VUERBVEUsIG5ld1ZhbHVlOiB7IFtjb2x1bW4uZmllbGRdOiBlbWl0dGVkQXJncy5uZXdWYWx1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKGdyaWQudHJhbnNhY3Rpb25zLmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICBncmlkLnRyYW5zYWN0aW9ucy5hZGQodHJhbnNhY3Rpb24sIGN1cnJlbnRHcmlkRWRpdFN0YXRlLnJvd0RhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCByb3dWYWx1ZSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkKVtyb3dJbmRleF07XG4gICAgICAgICAgICAgICAgbWVyZ2VPYmplY3RzKHJvd1ZhbHVlLCB7W2NvbHVtbi5maWVsZF06IGVtaXR0ZWRBcmdzLm5ld1ZhbHVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGdyaWQucHJpbWFyeUtleSA9PT0gY29sdW1uLmZpZWxkICYmIGN1cnJlbnRHcmlkRWRpdFN0YXRlLmlzUm93U2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICBncmlkLnNlbGVjdGlvbi5kZXNlbGVjdF9pdGVtKGlkLCByb3dJRCk7XG4gICAgICAgICAgICAgICAgZ3JpZC5zZWxlY3Rpb24uc2VsZWN0X2l0ZW0oaWQsIGVtaXR0ZWRBcmdzLm5ld1ZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZ3JpZC5yb3dFZGl0YWJsZSB8fCAhZ3JpZC5yb3dJbkVkaXRNb2RlIHx8IGdyaWQucm93SW5FZGl0TW9kZS5yb3dJRCAhPT0gcm93SUQpIHtcbiAgICAgICAgICAgICAgICAoZ3JpZCBhcyBhbnkpLl9waXBlVHJpZ2dlcisrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZV9yb3codmFsdWU6IGFueSwgaWQ6IHN0cmluZywgcm93SUQ6IGFueSwgZ3JpZFN0YXRlPzoge1xuICAgICAgICBhcmdzOiBJR3JpZEVkaXRFdmVudEFyZ3MsXG4gICAgICAgIGlzUm93U2VsZWN0ZWQ6IGJvb2xlYW4sXG4gICAgICAgIHJvd0RhdGE6IGFueVxuICAgIH0pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0KGlkKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0X2FsbF9kYXRhKGlkKTtcbiAgICAgICAgY29uc3QgY3VycmVudEdyaWRTdGF0ZSA9IGdyaWRTdGF0ZSA/IGdyaWRTdGF0ZSA6IHRoaXMuY3JlYXRlX2dyaWRfZWRpdF9hcmdzKGlkLCByb3dJRCwgbnVsbCwgdmFsdWUpO1xuICAgICAgICBjb25zdCBlbWl0QXJncyA9IGN1cnJlbnRHcmlkU3RhdGUuYXJncztcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmdldF9yb3dfaW5kZXhfaW5fZGF0YShpZCwgcm93SUQpO1xuICAgICAgICBjb25zdCBjdXJyZW50Um93SW5FZGl0TW9kZSA9IHRoaXMuZ2V0X2VkaXRfcm93X3N0YXRlKGlkKTtcbiAgICAgICAgbGV0IG9sZFZhbHVlID0gT2JqZWN0LmFzc2lnbih7fSwgZGF0YVtpbmRleF0pO1xuICAgICAgICBpZiAoZ3JpZC5jdXJyZW50Um93U3RhdGUgJiYgZ3JpZC5jdXJyZW50Um93U3RhdGVbZ3JpZC5wcmltYXJ5S2V5XSA9PT0gcm93SURcbiAgICAgICAgICAgIHx8IGN1cnJlbnRSb3dJbkVkaXRNb2RlICYmIGN1cnJlbnRSb3dJbkVkaXRNb2RlLnJvd0lEID09PSByb3dJRCkge1xuICAgICAgICAgICAgb2xkVmFsdWUgPSBPYmplY3QuYXNzaWduKG9sZFZhbHVlLCBncmlkLmN1cnJlbnRSb3dTdGF0ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZ3JpZC50cmFuc2FjdGlvbnMuZW5hYmxlZCkge1xuICAgICAgICAgICAgLy8gSWYgdHJhbnNhY3Rpb25zIGFyZSBlbmFibGVkLCBvbGQgdmFsdWUgPT0gbGFzdCBjb21taXRlZCB2YWx1ZSAoYXMgaXQncyBub3QgYXBwbGllZCBpbiBkYXRhIHlldClcbiAgICAgICAgICAgIGNvbnN0IGxhc3RDb21taXRlZFZhbHVlID0gLy8gTGFzdCBjb21taXRlZCB2YWx1ZSAody9vIHBlbmRpbmcpXG4gICAgICAgICAgICAgICAgZ3JpZC50cmFuc2FjdGlvbnMuZ2V0U3RhdGUocm93SUQpID8gT2JqZWN0LmFzc2lnbih7fSwgZ3JpZC50cmFuc2FjdGlvbnMuZ2V0U3RhdGUocm93SUQpLnZhbHVlKSA6IG51bGw7XG4gICAgICAgICAgICBvbGRWYWx1ZSA9IGxhc3RDb21taXRlZFZhbHVlID8gT2JqZWN0LmFzc2lnbihvbGRWYWx1ZSwgbGFzdENvbW1pdGVkVmFsdWUpIDogb2xkVmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmFzc2lnbihlbWl0QXJncywgeyBvbGRWYWx1ZSwgcm93SUR9KTtcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgZ3JpZC5vblJvd0VkaXQuZW1pdChlbWl0QXJncyk7XG4gICAgICAgICAgICBpZiAoZW1pdEFyZ3MuY2FuY2VsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3dJbkVkaXRNb2RlKSB7XG4gICAgICAgICAgICAgICAgZ3JpZC50cmFuc2FjdGlvbnMuZW5kUGVuZGluZyhmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZ3JpZC50cmFuc2FjdGlvbnMuZW5hYmxlZCAmJiBlbWl0QXJncy5uZXdWYWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGdyaWQudHJhbnNhY3Rpb25zLmFkZCh7aWQ6IHJvd0lELCBuZXdWYWx1ZTogZW1pdEFyZ3MubmV3VmFsdWUsIHR5cGU6IFRyYW5zYWN0aW9uVHlwZS5VUERBVEV9LCBlbWl0QXJncy5vbGRWYWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVtaXRBcmdzLm5ld1ZhbHVlICE9PSBudWxsICYmIGVtaXRBcmdzLm5ld1ZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGRhdGFbaW5kZXhdLCBlbWl0QXJncy5uZXdWYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY3VycmVudEdyaWRTdGF0ZS5pc1Jvd1NlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgZ3JpZC5zZWxlY3Rpb24uZGVzZWxlY3RfaXRlbShpZCwgcm93SUQpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1Jvd0lEID0gKGdyaWQucHJpbWFyeUtleSkgPyBlbWl0QXJncy5uZXdWYWx1ZVtncmlkLnByaW1hcnlLZXldIDogZW1pdEFyZ3MubmV3VmFsdWU7XG4gICAgICAgICAgICAgICAgZ3JpZC5zZWxlY3Rpb24uc2VsZWN0X2l0ZW0oaWQsIG5ld1Jvd0lEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIChncmlkIGFzIGFueSkuX3BpcGVUcmlnZ2VyKys7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdXBkYXRlX3Jvd19pbl9hcnJheShpZDogc3RyaW5nLCB2YWx1ZTogYW55LCByb3dJRDogYW55LCBpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdldChpZCk7XG4gICAgICAgIGdyaWQuZGF0YVtpbmRleF0gPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc29ydChpZDogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZywgZGlyOiBTb3J0aW5nRGlyZWN0aW9uLCBpZ25vcmVDYXNlOiBib29sZWFuLCBzdHJhdGVneTogSVNvcnRpbmdTdHJhdGVneSk6IHZvaWQge1xuICAgICAgICBpZiAoZGlyID09PSBTb3J0aW5nRGlyZWN0aW9uLk5vbmUpIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlX2dyb3VwaW5nX2V4cHJlc3Npb24oaWQsIGZpZWxkTmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc29ydGluZ1N0YXRlID0gY2xvbmVBcnJheSh0aGlzLmdldChpZCkuc29ydGluZ0V4cHJlc3Npb25zKTtcbiAgICAgICAgc3RyYXRlZ3kgPSBzdHJhdGVneSA/IHN0cmF0ZWd5IDogdGhpcy5nZXRTb3J0U3RyYXRlZ3lQZXJDb2x1bW4oaWQsIGZpZWxkTmFtZSk7XG4gICAgICAgIHRoaXMucHJlcGFyZV9zb3J0aW5nX2V4cHJlc3Npb24oW3NvcnRpbmdTdGF0ZV0sIHsgZmllbGROYW1lLCBkaXIsIGlnbm9yZUNhc2UsIHN0cmF0ZWd5IH0pO1xuICAgICAgICB0aGlzLmdldChpZCkuc29ydGluZ0V4cHJlc3Npb25zID0gc29ydGluZ1N0YXRlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzb3J0X211bHRpcGxlKGlkOiBzdHJpbmcsIGV4cHJlc3Npb25zOiBJU29ydGluZ0V4cHJlc3Npb25bXSk6IHZvaWQge1xuICAgICAgICBjb25zdCBzb3J0aW5nU3RhdGUgPSBjbG9uZUFycmF5KHRoaXMuZ2V0KGlkKS5zb3J0aW5nRXhwcmVzc2lvbnMpO1xuXG4gICAgICAgIGZvciAoY29uc3QgZWFjaCBvZiBleHByZXNzaW9ucykge1xuICAgICAgICAgICAgaWYgKGVhY2guZGlyID09PSBTb3J0aW5nRGlyZWN0aW9uLk5vbmUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZV9ncm91cGluZ19leHByZXNzaW9uKGlkLCBlYWNoLmZpZWxkTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlYWNoLnN0cmF0ZWd5ID0gZWFjaC5zdHJhdGVneSA/IGVhY2guc3RyYXRlZ3kgOiB0aGlzLmdldFNvcnRTdHJhdGVneVBlckNvbHVtbihpZCwgZWFjaC5maWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5wcmVwYXJlX3NvcnRpbmdfZXhwcmVzc2lvbihbc29ydGluZ1N0YXRlXSwgZWFjaCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdldChpZCkuc29ydGluZ0V4cHJlc3Npb25zID0gc29ydGluZ1N0YXRlO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXIoaWQ6IHN0cmluZywgZmllbGROYW1lOiBzdHJpbmcsIHRlcm0sIGNvbmRpdGlvbk9yRXhwcmVzc2lvbnNUcmVlOiBJRmlsdGVyaW5nT3BlcmF0aW9uIHwgSUZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSxcbiAgICAgICAgaWdub3JlQ2FzZTogYm9vbGVhbikge1xuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQoaWQpO1xuICAgICAgICBjb25zdCBmaWx0ZXJpbmdUcmVlID0gZ3JpZC5maWx0ZXJpbmdFeHByZXNzaW9uc1RyZWU7XG4gICAgICAgIGdyaWQuZW5kRWRpdChmYWxzZSk7XG5cbiAgICAgICAgaWYgKGdyaWQucGFnaW5nKSB7XG4gICAgICAgICAgICBncmlkLnBhZ2UgPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZmllbGRGaWx0ZXJJbmRleCA9IGZpbHRlcmluZ1RyZWUuZmluZEluZGV4KGZpZWxkTmFtZSk7XG4gICAgICAgIGlmIChmaWVsZEZpbHRlckluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIGZpbHRlcmluZ1RyZWUuZmlsdGVyaW5nT3BlcmFuZHMuc3BsaWNlKGZpZWxkRmlsdGVySW5kZXgsIDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wcmVwYXJlX2ZpbHRlcmluZ19leHByZXNzaW9uKGZpbHRlcmluZ1RyZWUsIGZpZWxkTmFtZSwgdGVybSwgY29uZGl0aW9uT3JFeHByZXNzaW9uc1RyZWUsIGlnbm9yZUNhc2UpO1xuICAgICAgICBncmlkLmZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSA9IGZpbHRlcmluZ1RyZWU7XG4gICAgfVxuXG4gICAgcHVibGljIGZpbHRlcl9nbG9iYWwoaWQsIHRlcm0sIGNvbmRpdGlvbiwgaWdub3JlQ2FzZSkge1xuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQoaWQpO1xuICAgICAgICBjb25zdCBmaWx0ZXJpbmdUcmVlID0gZ3JpZC5maWx0ZXJpbmdFeHByZXNzaW9uc1RyZWU7XG4gICAgICAgIGlmIChncmlkLnBhZ2luZykge1xuICAgICAgICAgICAgZ3JpZC5wYWdlID0gMDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZpbHRlcmluZ1RyZWUuZmlsdGVyaW5nT3BlcmFuZHMgPSBbXTtcbiAgICAgICAgdGhpcy5yZW1vdmVfc3VtbWFyeShpZCk7XG5cbiAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgZm9yIChjb25zdCBjb2x1bW4gb2YgZ3JpZC5jb2x1bW5zKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcmVwYXJlX2ZpbHRlcmluZ19leHByZXNzaW9uKGZpbHRlcmluZ1RyZWUsIGNvbHVtbi5maWVsZCwgdGVybSxcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLCBpZ25vcmVDYXNlIHx8IGNvbHVtbi5maWx0ZXJpbmdJZ25vcmVDYXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGdyaWQuZmlsdGVyaW5nRXhwcmVzc2lvbnNUcmVlID0gZmlsdGVyaW5nVHJlZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJfZmlsdGVyKGlkLCBmaWVsZE5hbWUpIHtcbiAgICAgICAgaWYgKGZpZWxkTmFtZSkge1xuICAgICAgICAgICAgY29uc3QgY29sdW1uID0gdGhpcy5nZXRfY29sdW1uX2J5X25hbWUoaWQsIGZpZWxkTmFtZSk7XG4gICAgICAgICAgICBpZiAoIWNvbHVtbikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdldChpZCk7XG4gICAgICAgIGNvbnN0IGZpbHRlcmluZ1N0YXRlID0gZ3JpZC5maWx0ZXJpbmdFeHByZXNzaW9uc1RyZWU7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gZmlsdGVyaW5nU3RhdGUuZmluZEluZGV4KGZpZWxkTmFtZSk7XG5cbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIGZpbHRlcmluZ1N0YXRlLmZpbHRlcmluZ09wZXJhbmRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZV9zdW1tYXJ5KGlkLCBmaWVsZE5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmlsdGVyaW5nU3RhdGUuZmlsdGVyaW5nT3BlcmFuZHMgPSBbXTtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlX3N1bW1hcnkoaWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgZ3JpZC5maWx0ZXJlZERhdGEgPSBudWxsO1xuICAgICAgICBncmlkLmZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSA9IGZpbHRlcmluZ1N0YXRlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjYWxjdWxhdGVTdW1tYXJpZXMoaWQ6IHN0cmluZywgY29sdW1uLCBkYXRhKSB7XG4gICAgICAgIGlmICghdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZ2V0KGlkKS5nZXQoY29sdW1uLmZpZWxkKSkge1xuICAgICAgICAgICAgdGhpcy5zdW1tYXJ5Q2FjaGVNYXAuZ2V0KGlkKS5zZXQoY29sdW1uLmZpZWxkLFxuICAgICAgICAgICAgICAgIGNvbHVtbi5zdW1tYXJpZXMub3BlcmF0ZShkYXRhKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJfc29ydChpZCwgZmllbGROYW1lKSB7XG4gICAgICAgIGNvbnN0IHNvcnRpbmdTdGF0ZSA9IHRoaXMuZ2V0KGlkKS5zb3J0aW5nRXhwcmVzc2lvbnM7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gc29ydGluZ1N0YXRlLmZpbmRJbmRleCgoZXhwcikgPT4gZXhwci5maWVsZE5hbWUgPT09IGZpZWxkTmFtZSk7XG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBzb3J0aW5nU3RhdGUuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0KGlkKS5zb3J0aW5nRXhwcmVzc2lvbnMgPSBzb3J0aW5nU3RhdGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcHJlcGFyZV9maWx0ZXJpbmdfZXhwcmVzc2lvbihmaWx0ZXJpbmdTdGF0ZTogSUZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSwgZmllbGROYW1lOiBzdHJpbmcsIHNlYXJjaFZhbCxcbiAgICAgICAgY29uZGl0aW9uT3JFeHByZXNzaW9uc1RyZWU6IElGaWx0ZXJpbmdPcGVyYXRpb24gfCBJRmlsdGVyaW5nRXhwcmVzc2lvbnNUcmVlLCBpZ25vcmVDYXNlOiBib29sZWFuKSB7XG5cbiAgICAgICAgbGV0IG5ld0V4cHJlc3Npb25zVHJlZTtcbiAgICAgICAgY29uc3Qgb2xkRXhwcmVzc2lvbnNUcmVlSW5kZXggPSBmaWx0ZXJpbmdTdGF0ZS5maW5kSW5kZXgoZmllbGROYW1lKTtcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbnNUcmVlID0gY29uZGl0aW9uT3JFeHByZXNzaW9uc1RyZWUgaW5zdGFuY2VvZiBGaWx0ZXJpbmdFeHByZXNzaW9uc1RyZWUgP1xuICAgICAgICAgICAgY29uZGl0aW9uT3JFeHByZXNzaW9uc1RyZWUgYXMgSUZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSA6IG51bGw7XG4gICAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGNvbmRpdGlvbk9yRXhwcmVzc2lvbnNUcmVlIGluc3RhbmNlb2YgRmlsdGVyaW5nRXhwcmVzc2lvbnNUcmVlID9cbiAgICAgICAgICAgIG51bGwgOiBjb25kaXRpb25PckV4cHJlc3Npb25zVHJlZSBhcyBJRmlsdGVyaW5nT3BlcmF0aW9uO1xuICAgICAgICBjb25zdCBuZXdFeHByZXNzaW9uOiBJRmlsdGVyaW5nRXhwcmVzc2lvbiA9IHsgZmllbGROYW1lLCBzZWFyY2hWYWwsIGNvbmRpdGlvbiwgaWdub3JlQ2FzZSB9O1xuXG4gICAgICAgIGlmIChvbGRFeHByZXNzaW9uc1RyZWVJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgIC8vIG5vIGV4cHJlc3Npb25zIHRyZWUgZm91bmQgZm9yIHRoaXMgZmllbGRcbiAgICAgICAgICAgIGlmIChleHByZXNzaW9uc1RyZWUpIHtcbiAgICAgICAgICAgICAgICBmaWx0ZXJpbmdTdGF0ZS5maWx0ZXJpbmdPcGVyYW5kcy5wdXNoKGV4cHJlc3Npb25zVHJlZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBleHByZXNzaW9ucyB0cmVlIGZvciB0aGlzIGZpZWxkIGFuZCBhZGQgdGhlIG5ldyBleHByZXNzaW9uIHRvIGl0XG4gICAgICAgICAgICAgICAgbmV3RXhwcmVzc2lvbnNUcmVlID0gbmV3IEZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZShmaWx0ZXJpbmdTdGF0ZS5vcGVyYXRvciwgZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICBuZXdFeHByZXNzaW9uc1RyZWUuZmlsdGVyaW5nT3BlcmFuZHMucHVzaChuZXdFeHByZXNzaW9uKTtcbiAgICAgICAgICAgICAgICBmaWx0ZXJpbmdTdGF0ZS5maWx0ZXJpbmdPcGVyYW5kcy5wdXNoKG5ld0V4cHJlc3Npb25zVHJlZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcHJlcGFyZV9zb3J0aW5nX2V4cHJlc3Npb24oc3RhdGVDb2xsZWN0aW9uczogQXJyYXk8QXJyYXk8YW55Pj4sIGV4cHJlc3Npb246IElTb3J0aW5nRXhwcmVzc2lvbikge1xuICAgICAgICBpZiAoZXhwcmVzc2lvbi5kaXIgPT09IFNvcnRpbmdEaXJlY3Rpb24uTm9uZSkge1xuICAgICAgICAgICAgc3RhdGVDb2xsZWN0aW9ucy5mb3JFYWNoKHN0YXRlID0+IHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5zcGxpY2Uoc3RhdGUuZmluZEluZGV4KChleHByKSA9PiBleHByLmZpZWxkTmFtZSA9PT0gZXhwcmVzc2lvbi5maWVsZE5hbWUpLCAxKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBzdGF0ZXMgaW4gZWFjaCBjb2xsZWN0aW9uIHdpdGggc2FtZSBmaWVsZHMgcG9pbnQgdG8gdGhlIHNhbWUgb2JqZWN0IHJlZmVyZW5jZS5cbiAgICAgICAgICogSWYgdGhlIGRpZmZlcmVudCBzdGF0ZSBjb2xsZWN0aW9ucyBwcm92aWRlZCBoYXZlIGRpZmZlcmVudCBzaXplcyB3ZSBuZWVkIHRvIGdldCB0aGUgbGFyZ2VzdCBvbmUuXG4gICAgICAgICAqIFRoYXQgd2F5IHdlIGNhbiBnZXQgdGhlIHN0YXRlIHJlZmVyZW5jZSBmcm9tIHRoZSBsYXJnZXN0IG9uZSB0aGF0IGhhcyB0aGUgc2FtZSBmaWVsZE5hbWUgYXMgdGhlIGV4cHJlc3Npb24gdG8gcHJlcGFyZS5cbiAgICAgICAgICovXG4gICAgICAgIGxldCBtYXhDb2xsZWN0aW9uID0gc3RhdGVDb2xsZWN0aW9uc1swXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzdGF0ZUNvbGxlY3Rpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAobWF4Q29sbGVjdGlvbi5sZW5ndGggPCBzdGF0ZUNvbGxlY3Rpb25zW2ldLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIG1heENvbGxlY3Rpb24gPSBzdGF0ZUNvbGxlY3Rpb25zW2ldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1heEV4cHIgPSBtYXhDb2xsZWN0aW9uLmZpbmQoKGV4cHIpID0+IGV4cHIuZmllbGROYW1lID09PSBleHByZXNzaW9uLmZpZWxkTmFtZSk7XG5cbiAgICAgICAgc3RhdGVDb2xsZWN0aW9ucy5mb3JFYWNoKGNvbGxlY3Rpb24gPT4ge1xuICAgICAgICAgICAgY29uc3QgbXlFeHByID0gY29sbGVjdGlvbi5maW5kKChleHByKSA9PiBleHByLmZpZWxkTmFtZSA9PT0gZXhwcmVzc2lvbi5maWVsZE5hbWUpO1xuICAgICAgICAgICAgaWYgKCFteUV4cHIgJiYgIW1heEV4cHIpIHtcbiAgICAgICAgICAgICAgICAvLyBFeHByZXNzaW9uIHdpdGggdGhpcyBmaWVsZE5hbWUgaXMgbWlzc2luZyBmcm9tIHRoZSBjdXJyZW50IGFuZCB0aGUgbWF4IGNvbGxlY3Rpb24uXG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbi5wdXNoKGV4cHJlc3Npb24pO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghbXlFeHByICYmIG1heEV4cHIpIHtcbiAgICAgICAgICAgICAgICAvLyBFeHByZXNzaW9uIHdpdGggdGhpcyBmaWVsZE5hbWUgaXMgbWlzc2luZyBmcm9tIHRoZSBjdXJyZW50IGFuZCBidXQgdGhlIG1heCBjb2xsZWN0aW9uIGhhcy5cbiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnB1c2gobWF4RXhwcik7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihtYXhFeHByLCBleHByZXNzaW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGN1cnJlbnQgY29sbGVjdGlvbiBoYXMgdGhlIGV4cHJlc3Npb24gc28ganVzdCB1cGRhdGUgaXQuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihteUV4cHIsIGV4cHJlc3Npb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVtb3ZlX2dyb3VwaW5nX2V4cHJlc3Npb24oaWQsIGZpZWxkTmFtZSkge1xuICAgICAgICB9XG5cbiAgICBwdWJsaWMgc2hvdWxkX2FwcGx5X251bWJlcl9zdHlsZShjb2x1bW46IElneENvbHVtbkNvbXBvbmVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gY29sdW1uLmRhdGFUeXBlID09PSBEYXRhVHlwZS5OdW1iZXI7XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9hbGxfZGF0YShpZDogc3RyaW5nLCB0cmFuc2FjdGlvbnM/OiBib29sZWFuKTogYW55W10ge1xuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5nZXQoaWQpO1xuICAgICAgICBjb25zdCBkYXRhID0gdHJhbnNhY3Rpb25zID8gZ3JpZC5kYXRhV2l0aEFkZGVkSW5UcmFuc2FjdGlvblJvd3MgOiBncmlkLmRhdGE7XG4gICAgICAgIHJldHVybiBkYXRhID8gZGF0YSA6IFtdO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRTb3J0U3RyYXRlZ3lQZXJDb2x1bW4oaWQ6IHN0cmluZywgZmllbGROYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0X2NvbHVtbl9ieV9uYW1lKHRoaXMuZ2V0KGlkKS5pZCwgZmllbGROYW1lKSA/XG4gICAgICAgICAgICB0aGlzLmdldF9jb2x1bW5fYnlfbmFtZShpZCwgZmllbGROYW1lKS5zb3J0U3RyYXRlZ3kgOiB1bmRlZmluZWQ7XG4gICAgfVxufVxuIl19
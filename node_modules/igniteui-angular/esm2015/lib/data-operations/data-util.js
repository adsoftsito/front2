/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { filteringStateDefaults } from './filtering-state.interface';
import { SortingStateDefaults } from './sorting-state.interface';
import { TreeGridSortingStrategy } from './sorting-strategy';
import { PagingError } from './paging-state.interface';
import { TransactionType } from '../services';
import { mergeObjects, cloneValue } from '../core/utils';
/** @enum {string} */
const DataType = {
    String: 'string',
    Number: 'number',
    Boolean: 'boolean',
    Date: 'date',
};
export { DataType };
/**
 * @hidden
 */
export class DataUtil {
    /**
     * @param {?} target
     * @param {?} defaults
     * @return {?}
     */
    static mergeDefaultProperties(target, defaults) {
        if (!defaults) {
            return target;
        }
        if (!target) {
            target = Object.assign({}, defaults);
            return target;
        }
        Object
            .keys(defaults)
            .forEach((key) => {
            if (target[key] === undefined && defaults[key] !== undefined) {
                target[key] = defaults[key];
            }
        });
        return target;
    }
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    static sort(data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        // apply default settings for each sorting expression(if not set)
        return state.strategy.sort(data, state.expressions);
    }
    /**
     * @param {?} hierarchicalData
     * @param {?} state
     * @param {?} parent
     * @return {?}
     */
    static hierarchicalSort(hierarchicalData, state, parent) {
        state.strategy = new TreeGridSortingStrategy();
        let /** @type {?} */ res = [];
        hierarchicalData.forEach((hr) => {
            const /** @type {?} */ rec = DataUtil.cloneTreeGridRecord(hr);
            rec.parent = parent;
            if (rec.children) {
                rec.children = DataUtil.hierarchicalSort(rec.children, state, rec);
            }
            res.push(rec);
        });
        res = DataUtil.sort(res, state);
        return res;
    }
    /**
     * @param {?} hierarchicalRecord
     * @return {?}
     */
    static cloneTreeGridRecord(hierarchicalRecord) {
        const /** @type {?} */ rec = {
            rowID: hierarchicalRecord.rowID,
            data: hierarchicalRecord.data,
            children: hierarchicalRecord.children,
            isFilteredOutParent: hierarchicalRecord.isFilteredOutParent,
            level: hierarchicalRecord.level,
            expanded: hierarchicalRecord.expanded,
            path: [...hierarchicalRecord.path]
        };
        return rec;
    }
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    static group(data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        // apply default settings for each grouping expression(if not set)
        return state.strategy.groupBy(data, state.expressions);
    }
    /**
     * @param {?} groupData
     * @param {?} state
     * @param {?=} groupsRecords
     * @return {?}
     */
    static restoreGroups(groupData, state, groupsRecords = []) {
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        if (state.expressions.length === 0) {
            return groupData.data;
        }
        return this.restoreGroupsRecursive(groupData, 1, state.expressions.length, state.expansion, state.defaultExpanded, groupsRecords);
    }
    /**
     * @param {?} groupData
     * @param {?} level
     * @param {?} depth
     * @param {?} expansion
     * @param {?} defaultExpanded
     * @param {?} groupsRecords
     * @return {?}
     */
    static restoreGroupsRecursive(groupData, level, depth, expansion, defaultExpanded, groupsRecords) {
        let /** @type {?} */ i = 0;
        let /** @type {?} */ j;
        let /** @type {?} */ result = [];
        // empty the array without changing reference
        groupsRecords.splice(0, groupsRecords.length);
        if (level !== depth) {
            groupData.data = this.restoreGroupsRecursive(groupData, level + 1, depth, expansion, defaultExpanded, groupsRecords);
        }
        while (i < groupData.data.length) {
            const /** @type {?} */ g = level === depth ? groupData.metadata[i] :
                groupData.data[i].groupParent;
            for (j = i + 1; j < groupData.data.length; j++) {
                const /** @type {?} */ h = level === depth ? groupData.metadata[j] :
                    groupData.data[j].groupParent;
                if (h && g !== h && g.level === h.level) {
                    break;
                }
            }
            const /** @type {?} */ hierarchy = this.getHierarchy(g);
            const /** @type {?} */ expandState = expansion.find((state) => this.isHierarchyMatch(state.hierarchy || [{ fieldName: g.expression.fieldName, value: g.value }], hierarchy));
            const /** @type {?} */ expanded = expandState ? expandState.expanded : defaultExpanded;
            result.push(g);
            groupsRecords.push(g);
            g['groups'] = groupData.data.slice(i, j).filter((e) => e.records && e.records.length && e.level === g.level + 1);
            while (groupsRecords.length) {
                if (groupsRecords[0].level + 1 > level) {
                    groupsRecords.shift();
                }
                else {
                    break;
                }
            }
            if (expanded) {
                result = result.concat(groupData.data.slice(i, j));
            }
            i = j;
        }
        return result;
    }
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    static page(data, state) {
        if (!state) {
            return data;
        }
        const /** @type {?} */ len = data.length;
        const /** @type {?} */ index = state.index;
        const /** @type {?} */ res = [];
        const /** @type {?} */ recordsPerPage = state.recordsPerPage;
        state.metadata = {
            countPages: 0,
            countRecords: data.length,
            error: PagingError.None
        };
        if (index < 0 || isNaN(index)) {
            state.metadata.error = PagingError.IncorrectPageIndex;
            return res;
        }
        if (recordsPerPage <= 0 || isNaN(recordsPerPage)) {
            state.metadata.error = PagingError.IncorrectRecordsPerPage;
            return res;
        }
        state.metadata.countPages = Math.ceil(len / recordsPerPage);
        if (!len) {
            return data;
        }
        if (index >= state.metadata.countPages) {
            state.metadata.error = PagingError.IncorrectPageIndex;
            return res;
        }
        return data.slice(index * recordsPerPage, (index + 1) * recordsPerPage);
    }
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    static filter(data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, filteringStateDefaults);
        if (!state.strategy) {
            return data;
        }
        return state.strategy.filter(data, state.expressionsTree);
    }
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    static process(data, state) {
        if (!state) {
            return data;
        }
        if (state.filtering) {
            data = DataUtil.filter(data, state.filtering);
        }
        if (state.sorting) {
            data = DataUtil.sort(data, state.sorting);
        }
        if (state.paging) {
            data = DataUtil.page(data, state.paging);
        }
        return data;
    }
    /**
     * @param {?} gRow
     * @return {?}
     */
    static getHierarchy(gRow) {
        const /** @type {?} */ hierarchy = [];
        if (gRow !== undefined && gRow.expression) {
            hierarchy.push({ fieldName: gRow.expression.fieldName, value: gRow.value });
            while (gRow.groupParent) {
                gRow = gRow.groupParent;
                hierarchy.unshift({ fieldName: gRow.expression.fieldName, value: gRow.value });
            }
        }
        return hierarchy;
    }
    /**
     * @param {?} h1
     * @param {?} h2
     * @return {?}
     */
    static isHierarchyMatch(h1, h2) {
        if (h1.length !== h2.length) {
            return false;
        }
        return h1.every((level, index) => {
            return level.fieldName === h2[index].fieldName && level.value === h2[index].value;
        });
    }
    /**
     * Merges all changes from provided transactions into provided data collection
     * @template T
     * @param {?} data Collection to merge
     * @param {?} transactions Transactions to merge into data
     * @param {?=} primaryKey Primary key of the collection, if any
     * @return {?}
     */
    static mergeTransactions(data, transactions, primaryKey) {
        data.forEach((item, index) => {
            const /** @type {?} */ rowId = primaryKey ? item[primaryKey] : item;
            const /** @type {?} */ transaction = transactions.find(t => t.id === rowId);
            if (Array.isArray(item.children)) {
                this.mergeTransactions(item.children, transactions, primaryKey);
            }
            if (transaction && transaction.type === TransactionType.UPDATE) {
                data[index] = transaction.newValue;
            }
        });
        data.push(...transactions
            .filter(t => t.type === TransactionType.ADD)
            .map(t => t.newValue));
        return data;
    }
    /**
     * \@experimental \@hidden
     * @param {?} data
     * @param {?} transactions
     * @param {?} childDataKey
     * @param {?=} primaryKey
     * @param {?=} parentKey
     * @return {?}
     */
    static mergeHierarchicalTransactions(data, transactions, childDataKey, primaryKey, parentKey) {
        for (let /** @type {?} */ index = 0; index < data.length; index++) {
            const /** @type {?} */ dataItem = data[index];
            const /** @type {?} */ rowId = primaryKey ? dataItem[primaryKey] : dataItem;
            const /** @type {?} */ updateTransaction = transactions.filter(t => t.type === TransactionType.UPDATE).find(t => t.id === rowId);
            const /** @type {?} */ addedTransactions = transactions.filter(t => t.type === TransactionType.ADD).filter(t => t.parentId === rowId);
            if (updateTransaction || addedTransactions.length > 0) {
                data[index] = mergeObjects(cloneValue(dataItem), updateTransaction && updateTransaction.newValue);
            }
            if (addedTransactions.length > 0) {
                if (!data[index][childDataKey]) {
                    data[index][childDataKey] = [];
                }
                for (const /** @type {?} */ addedTransaction of addedTransactions) {
                    data[index][childDataKey].push(addedTransaction.newValue);
                }
            }
            if (data[index][childDataKey]) {
                data[index][childDataKey] = this.mergeHierarchicalTransactions(data[index][childDataKey], transactions, childDataKey, primaryKey, rowId);
            }
        }
        return data;
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS11dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsc0JBQXNCLEVBQW1CLE1BQU0sNkJBQTZCLENBQUM7QUFDdEYsT0FBTyxFQUFpQixvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2hGLE9BQU8sRUFBa0IsdUJBQXVCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM3RSxPQUFPLEVBQWdCLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBS3JFLE9BQU8sRUFBZSxlQUFlLEVBQWlGLE1BQU0sYUFBYSxDQUFDO0FBQzFJLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7WUFPNUMsUUFBUTtZQUNSLFFBQVE7YUFDUCxTQUFTO1VBQ1osTUFBTTs7Ozs7O0FBTWpCLE1BQU07Ozs7OztJQUNLLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxNQUFjLEVBQUUsUUFBZ0I7UUFDakUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ1osTUFBTSxDQUFDLE1BQU0sQ0FBQztTQUNqQjtRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNWLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDO1NBQ2pCO1FBQ0QsTUFBTTthQUNELElBQUksQ0FBQyxRQUFRLENBQUM7YUFDZCxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNiLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FB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LCBJRmlsdGVyaW5nU3RhdGUgfSBmcm9tICcuL2ZpbHRlcmluZy1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSVNvcnRpbmdTdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMgfSBmcm9tICcuL3NvcnRpbmctc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcm91cEJ5UmVzdWx0LCBUcmVlR3JpZFNvcnRpbmdTdHJhdGVneSB9IGZyb20gJy4vc29ydGluZy1zdHJhdGVneSc7XG5pbXBvcnQgeyBJUGFnaW5nU3RhdGUsIFBhZ2luZ0Vycm9yIH0gZnJvbSAnLi9wYWdpbmctc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElEYXRhU3RhdGUgfSBmcm9tICcuL2RhdGEtc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcm91cEJ5RXhwYW5kU3RhdGUsIElHcm91cEJ5S2V5IH0gZnJvbSAnLi9ncm91cGJ5LWV4cGFuZC1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSUdyb3VwQnlSZWNvcmQgfSBmcm9tICcuL2dyb3VwYnktcmVjb3JkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBJR3JvdXBpbmdTdGF0ZSB9IGZyb20gJy4vZ3JvdXBieS1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb24sIFRyYW5zYWN0aW9uVHlwZSwgSGllcmFyY2hpY2FsVHJhbnNhY3Rpb24sIElneEhpZXJhcmNoaWNhbFRyYW5zYWN0aW9uU2VydmljZSwgSGllcmFyY2hpY2FsU3RhdGUgfSBmcm9tICcuLi9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBtZXJnZU9iamVjdHMsIGNsb25lVmFsdWUgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcbmltcG9ydCB7IElUcmVlR3JpZFJlY29yZCB9IGZyb20gJy4uL2dyaWRzL3RyZWUtZ3JpZC90cmVlLWdyaWQuaW50ZXJmYWNlcyc7XG5cbi8qKlxuICogQGhpZGRlblxuICovXG5leHBvcnQgZW51bSBEYXRhVHlwZSB7XG4gICAgU3RyaW5nID0gJ3N0cmluZycsXG4gICAgTnVtYmVyID0gJ251bWJlcicsXG4gICAgQm9vbGVhbiA9ICdib29sZWFuJyxcbiAgICBEYXRlID0gJ2RhdGUnXG59XG5cbi8qKlxuICogQGhpZGRlblxuICovXG5leHBvcnQgY2xhc3MgRGF0YVV0aWwge1xuICAgIHB1YmxpYyBzdGF0aWMgbWVyZ2VEZWZhdWx0UHJvcGVydGllcyh0YXJnZXQ6IG9iamVjdCwgZGVmYXVsdHM6IG9iamVjdCkge1xuICAgICAgICBpZiAoIWRlZmF1bHRzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXQgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0cyk7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICB9XG4gICAgICAgIE9iamVjdFxuICAgICAgICAgICAgLmtleXMoZGVmYXVsdHMpXG4gICAgICAgICAgICAuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldFtrZXldID09PSB1bmRlZmluZWQgJiYgZGVmYXVsdHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gZGVmYXVsdHNba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBzb3J0PFQ+KGRhdGE6IFRbXSwgc3RhdGU6IElTb3J0aW5nU3RhdGUpOiBUW10ge1xuICAgICAgICAvLyBzZXQgZGVmYXVsdHNcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMpO1xuICAgICAgICAvLyBhcHBseSBkZWZhdWx0IHNldHRpbmdzIGZvciBlYWNoIHNvcnRpbmcgZXhwcmVzc2lvbihpZiBub3Qgc2V0KVxuICAgICAgICByZXR1cm4gc3RhdGUuc3RyYXRlZ3kuc29ydChkYXRhLCBzdGF0ZS5leHByZXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBoaWVyYXJjaGljYWxTb3J0KGhpZXJhcmNoaWNhbERhdGE6IElUcmVlR3JpZFJlY29yZFtdLCBzdGF0ZTogSVNvcnRpbmdTdGF0ZSwgcGFyZW50OiBJVHJlZUdyaWRSZWNvcmQpOiBJVHJlZUdyaWRSZWNvcmRbXSB7XG4gICAgICAgIHN0YXRlLnN0cmF0ZWd5ID0gbmV3IFRyZWVHcmlkU29ydGluZ1N0cmF0ZWd5KCk7XG4gICAgICAgIGxldCByZXM6IElUcmVlR3JpZFJlY29yZFtdID0gW107XG5cbiAgICAgICAgaGllcmFyY2hpY2FsRGF0YS5mb3JFYWNoKChocjogSVRyZWVHcmlkUmVjb3JkKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWM6IElUcmVlR3JpZFJlY29yZCA9IERhdGFVdGlsLmNsb25lVHJlZUdyaWRSZWNvcmQoaHIpO1xuICAgICAgICAgICAgcmVjLnBhcmVudCA9IHBhcmVudDtcbiAgICAgICAgICAgIGlmIChyZWMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICByZWMuY2hpbGRyZW4gPSBEYXRhVXRpbC5oaWVyYXJjaGljYWxTb3J0KHJlYy5jaGlsZHJlbiwgc3RhdGUsIHJlYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXMucHVzaChyZWMpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXMgPSBEYXRhVXRpbC5zb3J0KHJlcywgc3RhdGUpO1xuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjbG9uZVRyZWVHcmlkUmVjb3JkKGhpZXJhcmNoaWNhbFJlY29yZDogSVRyZWVHcmlkUmVjb3JkKSB7XG4gICAgICAgIGNvbnN0IHJlYzogSVRyZWVHcmlkUmVjb3JkID0ge1xuICAgICAgICAgICAgcm93SUQ6IGhpZXJhcmNoaWNhbFJlY29yZC5yb3dJRCxcbiAgICAgICAgICAgIGRhdGE6IGhpZXJhcmNoaWNhbFJlY29yZC5kYXRhLFxuICAgICAgICAgICAgY2hpbGRyZW46IGhpZXJhcmNoaWNhbFJlY29yZC5jaGlsZHJlbixcbiAgICAgICAgICAgIGlzRmlsdGVyZWRPdXRQYXJlbnQ6IGhpZXJhcmNoaWNhbFJlY29yZC5pc0ZpbHRlcmVkT3V0UGFyZW50LFxuICAgICAgICAgICAgbGV2ZWw6IGhpZXJhcmNoaWNhbFJlY29yZC5sZXZlbCxcbiAgICAgICAgICAgIGV4cGFuZGVkOiBoaWVyYXJjaGljYWxSZWNvcmQuZXhwYW5kZWQsXG4gICAgICAgICAgICBwYXRoOiBbLi4uaGllcmFyY2hpY2FsUmVjb3JkLnBhdGhdXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiByZWM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBncm91cDxUPihkYXRhOiBUW10sIHN0YXRlOiBJR3JvdXBpbmdTdGF0ZSk6IElHcm91cEJ5UmVzdWx0IHtcbiAgICAgICAgLy8gc2V0IGRlZmF1bHRzXG4gICAgICAgIERhdGFVdGlsLm1lcmdlRGVmYXVsdFByb3BlcnRpZXMoc3RhdGUsIFNvcnRpbmdTdGF0ZURlZmF1bHRzKTtcbiAgICAgICAgLy8gYXBwbHkgZGVmYXVsdCBzZXR0aW5ncyBmb3IgZWFjaCBncm91cGluZyBleHByZXNzaW9uKGlmIG5vdCBzZXQpXG4gICAgICAgIHJldHVybiBzdGF0ZS5zdHJhdGVneS5ncm91cEJ5KGRhdGEsIHN0YXRlLmV4cHJlc3Npb25zKTtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyByZXN0b3JlR3JvdXBzKGdyb3VwRGF0YTogSUdyb3VwQnlSZXN1bHQsIHN0YXRlOiBJR3JvdXBpbmdTdGF0ZSwgZ3JvdXBzUmVjb3JkczogYW55W10gPSBbXSk6IGFueVtdIHtcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMpO1xuICAgICAgICBpZiAoc3RhdGUuZXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3JvdXBEYXRhLmRhdGE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdG9yZUdyb3Vwc1JlY3Vyc2l2ZShncm91cERhdGEsIDEsIHN0YXRlLmV4cHJlc3Npb25zLmxlbmd0aCwgc3RhdGUuZXhwYW5zaW9uLCBzdGF0ZS5kZWZhdWx0RXhwYW5kZWQsIGdyb3Vwc1JlY29yZHMpO1xuICAgIH1cbiAgICBwcml2YXRlIHN0YXRpYyByZXN0b3JlR3JvdXBzUmVjdXJzaXZlKFxuICAgICAgICBncm91cERhdGE6IElHcm91cEJ5UmVzdWx0LCBsZXZlbDogbnVtYmVyLCBkZXB0aDogbnVtYmVyLFxuICAgICAgICBleHBhbnNpb246IElHcm91cEJ5RXhwYW5kU3RhdGVbXSwgZGVmYXVsdEV4cGFuZGVkOiBib29sZWFuLCBncm91cHNSZWNvcmRzKTogYW55W10ge1xuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGxldCBqOiBudW1iZXI7XG4gICAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgICAgLy8gZW1wdHkgdGhlIGFycmF5IHdpdGhvdXQgY2hhbmdpbmcgcmVmZXJlbmNlXG4gICAgICAgIGdyb3Vwc1JlY29yZHMuc3BsaWNlKDAsIGdyb3Vwc1JlY29yZHMubGVuZ3RoKTtcbiAgICAgICAgaWYgKGxldmVsICE9PSBkZXB0aCkge1xuICAgICAgICAgICAgZ3JvdXBEYXRhLmRhdGEgPSB0aGlzLnJlc3RvcmVHcm91cHNSZWN1cnNpdmUoZ3JvdXBEYXRhLCBsZXZlbCArIDEsIGRlcHRoLCBleHBhbnNpb24sIGRlZmF1bHRFeHBhbmRlZCwgZ3JvdXBzUmVjb3Jkcyk7XG4gICAgICAgIH1cbiAgICAgICAgd2hpbGUgKGkgPCBncm91cERhdGEuZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGcgPSBsZXZlbCA9PT0gZGVwdGggPyBncm91cERhdGEubWV0YWRhdGFbaV0gOlxuICAgICAgICAgICAgICAgIGdyb3VwRGF0YS5kYXRhW2ldLmdyb3VwUGFyZW50O1xuICAgICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBncm91cERhdGEuZGF0YS5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGggPSBsZXZlbCA9PT0gZGVwdGggPyBncm91cERhdGEubWV0YWRhdGFbal0gOlxuICAgICAgICAgICAgICAgICAgICBncm91cERhdGEuZGF0YVtqXS5ncm91cFBhcmVudDtcbiAgICAgICAgICAgICAgICBpZiAoaCAmJiBnICE9PSBoICYmIGcubGV2ZWwgPT09IGgubGV2ZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gdGhpcy5nZXRIaWVyYXJjaHkoZyk7XG4gICAgICAgICAgICBjb25zdCBleHBhbmRTdGF0ZTogSUdyb3VwQnlFeHBhbmRTdGF0ZSA9IGV4cGFuc2lvbi5maW5kKChzdGF0ZSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLmlzSGllcmFyY2h5TWF0Y2goc3RhdGUuaGllcmFyY2h5IHx8IFt7IGZpZWxkTmFtZTogZy5leHByZXNzaW9uLmZpZWxkTmFtZSwgdmFsdWU6IGcudmFsdWUgfV0sIGhpZXJhcmNoeSkpO1xuICAgICAgICAgICAgY29uc3QgZXhwYW5kZWQgPSBleHBhbmRTdGF0ZSA/IGV4cGFuZFN0YXRlLmV4cGFuZGVkIDogZGVmYXVsdEV4cGFuZGVkO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goZyk7XG4gICAgICAgICAgICBncm91cHNSZWNvcmRzLnB1c2goZyk7XG5cbiAgICAgICAgICAgIGdbJ2dyb3VwcyddID0gZ3JvdXBEYXRhLmRhdGEuc2xpY2UoaSwgaikuZmlsdGVyKChlKSA9PlxuICAgICAgICAgICAgICAgIGUucmVjb3JkcyAmJiBlLnJlY29yZHMubGVuZ3RoICYmIGUubGV2ZWwgPT09IGcubGV2ZWwgKyAxKTtcbiAgICAgICAgICAgIHdoaWxlIChncm91cHNSZWNvcmRzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGlmIChncm91cHNSZWNvcmRzWzBdLmxldmVsICsgMSA+IGxldmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGdyb3Vwc1JlY29yZHMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXhwYW5kZWQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGdyb3VwRGF0YS5kYXRhLnNsaWNlKGksIGopKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGkgPSBqO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHB1YmxpYyBzdGF0aWMgcGFnZTxUPihkYXRhOiBUW10sIHN0YXRlOiBJUGFnaW5nU3RhdGUpOiBUW10ge1xuICAgICAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsZW4gPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5pbmRleDtcbiAgICAgICAgY29uc3QgcmVzID0gW107XG4gICAgICAgIGNvbnN0IHJlY29yZHNQZXJQYWdlID0gc3RhdGUucmVjb3Jkc1BlclBhZ2U7XG4gICAgICAgIHN0YXRlLm1ldGFkYXRhID0ge1xuICAgICAgICAgICAgY291bnRQYWdlczogMCxcbiAgICAgICAgICAgIGNvdW50UmVjb3JkczogZGF0YS5sZW5ndGgsXG4gICAgICAgICAgICBlcnJvcjogUGFnaW5nRXJyb3IuTm9uZVxuICAgICAgICB9O1xuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGlzTmFOKGluZGV4KSkge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RQYWdlSW5kZXg7XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWNvcmRzUGVyUGFnZSA8PSAwIHx8IGlzTmFOKHJlY29yZHNQZXJQYWdlKSkge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RSZWNvcmRzUGVyUGFnZTtcbiAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUubWV0YWRhdGEuY291bnRQYWdlcyA9IE1hdGguY2VpbChsZW4gLyByZWNvcmRzUGVyUGFnZSk7XG4gICAgICAgIGlmICghbGVuKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5kZXggPj0gc3RhdGUubWV0YWRhdGEuY291bnRQYWdlcykge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RQYWdlSW5kZXg7XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhLnNsaWNlKGluZGV4ICogcmVjb3Jkc1BlclBhZ2UsIChpbmRleCArIDEpICogcmVjb3Jkc1BlclBhZ2UpO1xuICAgIH1cbiAgICBwdWJsaWMgc3RhdGljIGZpbHRlcjxUPihkYXRhOiBUW10sIHN0YXRlOiBJRmlsdGVyaW5nU3RhdGUpOiBUW10ge1xuICAgICAgICAvLyBzZXQgZGVmYXVsdHNcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgZmlsdGVyaW5nU3RhdGVEZWZhdWx0cyk7XG4gICAgICAgIGlmICghc3RhdGUuc3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGF0ZS5zdHJhdGVneS5maWx0ZXIoZGF0YSwgc3RhdGUuZXhwcmVzc2lvbnNUcmVlKTtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBwcm9jZXNzPFQ+KGRhdGE6IFRbXSwgc3RhdGU6IElEYXRhU3RhdGUpOiBUW10ge1xuICAgICAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhdGUuZmlsdGVyaW5nKSB7XG4gICAgICAgICAgICBkYXRhID0gRGF0YVV0aWwuZmlsdGVyKGRhdGEsIHN0YXRlLmZpbHRlcmluZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXRlLnNvcnRpbmcpIHtcbiAgICAgICAgICAgIGRhdGEgPSBEYXRhVXRpbC5zb3J0KGRhdGEsIHN0YXRlLnNvcnRpbmcpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZS5wYWdpbmcpIHtcbiAgICAgICAgICAgIGRhdGEgPSBEYXRhVXRpbC5wYWdlKGRhdGEsIHN0YXRlLnBhZ2luZyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRIaWVyYXJjaHkoZ1JvdzogSUdyb3VwQnlSZWNvcmQpOiBBcnJheTxJR3JvdXBCeUtleT4ge1xuICAgICAgICBjb25zdCBoaWVyYXJjaHk6IEFycmF5PElHcm91cEJ5S2V5PiA9IFtdO1xuICAgICAgICBpZiAoZ1JvdyAhPT0gdW5kZWZpbmVkICYmIGdSb3cuZXhwcmVzc2lvbikge1xuICAgICAgICAgICAgaGllcmFyY2h5LnB1c2goeyBmaWVsZE5hbWU6IGdSb3cuZXhwcmVzc2lvbi5maWVsZE5hbWUsIHZhbHVlOiBnUm93LnZhbHVlIH0pO1xuICAgICAgICAgICAgd2hpbGUgKGdSb3cuZ3JvdXBQYXJlbnQpIHtcbiAgICAgICAgICAgICAgICBnUm93ID0gZ1Jvdy5ncm91cFBhcmVudDtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkudW5zaGlmdCh7IGZpZWxkTmFtZTogZ1Jvdy5leHByZXNzaW9uLmZpZWxkTmFtZSwgdmFsdWU6IGdSb3cudmFsdWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhpZXJhcmNoeTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGlzSGllcmFyY2h5TWF0Y2goaDE6IEFycmF5PElHcm91cEJ5S2V5PiwgaDI6IEFycmF5PElHcm91cEJ5S2V5Pik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoaDEubGVuZ3RoICE9PSBoMi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaDEuZXZlcnkoKGxldmVsLCBpbmRleCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGxldmVsLmZpZWxkTmFtZSA9PT0gaDJbaW5kZXhdLmZpZWxkTmFtZSAmJiBsZXZlbC52YWx1ZSA9PT0gaDJbaW5kZXhdLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNZXJnZXMgYWxsIGNoYW5nZXMgZnJvbSBwcm92aWRlZCB0cmFuc2FjdGlvbnMgaW50byBwcm92aWRlZCBkYXRhIGNvbGxlY3Rpb25cbiAgICAgKiBAcGFyYW0gZGF0YSBDb2xsZWN0aW9uIHRvIG1lcmdlXG4gICAgICogQHBhcmFtIHRyYW5zYWN0aW9ucyBUcmFuc2FjdGlvbnMgdG8gbWVyZ2UgaW50byBkYXRhXG4gICAgICogQHBhcmFtIHByaW1hcnlLZXkgUHJpbWFyeSBrZXkgb2YgdGhlIGNvbGxlY3Rpb24sIGlmIGFueVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbWVyZ2VUcmFuc2FjdGlvbnM8VD4oZGF0YTogVFtdLCB0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9uW10sIHByaW1hcnlLZXk/OiBhbnkpOiBUW10ge1xuICAgICAgICBkYXRhLmZvckVhY2goKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm93SWQgPSBwcmltYXJ5S2V5ID8gaXRlbVtwcmltYXJ5S2V5XSA6IGl0ZW07XG4gICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9ucy5maW5kKHQgPT4gdC5pZCA9PT0gcm93SWQpO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1lcmdlVHJhbnNhY3Rpb25zKGl0ZW0uY2hpbGRyZW4sIHRyYW5zYWN0aW9ucywgcHJpbWFyeUtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHJhbnNhY3Rpb24gJiYgdHJhbnNhY3Rpb24udHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlVQREFURSkge1xuICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdID0gdHJhbnNhY3Rpb24ubmV3VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRhdGEucHVzaCguLi50cmFuc2FjdGlvbnNcbiAgICAgICAgICAgIC5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5BREQpXG4gICAgICAgICAgICAubWFwKHQgPT4gdC5uZXdWYWx1ZSkpO1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBvcHRpbWl6ZSBhZGRpdGlvbiBvZiBhZGRlZCByb3dzLiBTaG91bGQgbm90IGZpbHRlciB0cmFuc2FjdGlvbiBpbiBlYWNoIHJlY3Vyc2lvbiEhIVxuICAgIC8qKiBAZXhwZXJpbWVudGFsIEBoaWRkZW4gKi9cbiAgICBwdWJsaWMgc3RhdGljIG1lcmdlSGllcmFyY2hpY2FsVHJhbnNhY3Rpb25zKFxuICAgICAgICBkYXRhOiBhbnlbXSxcbiAgICAgICAgdHJhbnNhY3Rpb25zOiBIaWVyYXJjaGljYWxUcmFuc2FjdGlvbltdLFxuICAgICAgICBjaGlsZERhdGFLZXk6IGFueSxcbiAgICAgICAgcHJpbWFyeUtleT86IGFueSxcbiAgICAgICAgcGFyZW50S2V5PzogYW55KTogYW55W10ge1xuXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgICAgY29uc3QgZGF0YUl0ZW0gPSBkYXRhW2luZGV4XTtcbiAgICAgICAgICAgIGNvbnN0IHJvd0lkID0gcHJpbWFyeUtleSA/IGRhdGFJdGVtW3ByaW1hcnlLZXldIDogZGF0YUl0ZW07XG4gICAgICAgICAgICBjb25zdCB1cGRhdGVUcmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9ucy5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5VUERBVEUpLmZpbmQodCA9PiB0LmlkID09PSByb3dJZCk7XG4gICAgICAgICAgICBjb25zdCBhZGRlZFRyYW5zYWN0aW9ucyA9IHRyYW5zYWN0aW9ucy5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5BREQpLmZpbHRlcih0ID0+IHQucGFyZW50SWQgPT09IHJvd0lkKTtcbiAgICAgICAgICAgIGlmICh1cGRhdGVUcmFuc2FjdGlvbiB8fCBhZGRlZFRyYW5zYWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgZGF0YVtpbmRleF0gPSBtZXJnZU9iamVjdHMoY2xvbmVWYWx1ZShkYXRhSXRlbSksIHVwZGF0ZVRyYW5zYWN0aW9uICYmIHVwZGF0ZVRyYW5zYWN0aW9uLm5ld1ZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhZGRlZFRyYW5zYWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFkYXRhW2luZGV4XVtjaGlsZERhdGFLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0gPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBhZGRlZFRyYW5zYWN0aW9uIG9mIGFkZGVkVHJhbnNhY3Rpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0ucHVzaChhZGRlZFRyYW5zYWN0aW9uLm5ld1ZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGF0YVtpbmRleF1bY2hpbGREYXRhS2V5XSkge1xuICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0gPSB0aGlzLm1lcmdlSGllcmFyY2hpY2FsVHJhbnNhY3Rpb25zKFxuICAgICAgICAgICAgICAgICAgICBkYXRhW2luZGV4XVtjaGlsZERhdGFLZXldLFxuICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkRGF0YUtleSxcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgICAgICAgICAgICAgcm93SWRcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbn1cbiJdfQ==
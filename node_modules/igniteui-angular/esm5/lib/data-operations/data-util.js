/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { filteringStateDefaults } from './filtering-state.interface';
import { SortingStateDefaults } from './sorting-state.interface';
import { TreeGridSortingStrategy } from './sorting-strategy';
import { PagingError } from './paging-state.interface';
import { TransactionType } from '../services';
import { mergeObjects, cloneValue } from '../core/utils';
/** @enum {string} */
var DataType = {
    String: 'string',
    Number: 'number',
    Boolean: 'boolean',
    Date: 'date',
};
export { DataType };
/**
 * @hidden
 */
var /**
 * @hidden
 */
DataUtil = /** @class */ (function () {
    function DataUtil() {
    }
    /**
     * @param {?} target
     * @param {?} defaults
     * @return {?}
     */
    DataUtil.mergeDefaultProperties = /**
     * @param {?} target
     * @param {?} defaults
     * @return {?}
     */
    function (target, defaults) {
        if (!defaults) {
            return target;
        }
        if (!target) {
            target = Object.assign({}, defaults);
            return target;
        }
        Object
            .keys(defaults)
            .forEach(function (key) {
            if (target[key] === undefined && defaults[key] !== undefined) {
                target[key] = defaults[key];
            }
        });
        return target;
    };
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    DataUtil.sort = /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    function (data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        // apply default settings for each sorting expression(if not set)
        return state.strategy.sort(data, state.expressions);
    };
    /**
     * @param {?} hierarchicalData
     * @param {?} state
     * @param {?} parent
     * @return {?}
     */
    DataUtil.hierarchicalSort = /**
     * @param {?} hierarchicalData
     * @param {?} state
     * @param {?} parent
     * @return {?}
     */
    function (hierarchicalData, state, parent) {
        state.strategy = new TreeGridSortingStrategy();
        var /** @type {?} */ res = [];
        hierarchicalData.forEach(function (hr) {
            var /** @type {?} */ rec = DataUtil.cloneTreeGridRecord(hr);
            rec.parent = parent;
            if (rec.children) {
                rec.children = DataUtil.hierarchicalSort(rec.children, state, rec);
            }
            res.push(rec);
        });
        res = DataUtil.sort(res, state);
        return res;
    };
    /**
     * @param {?} hierarchicalRecord
     * @return {?}
     */
    DataUtil.cloneTreeGridRecord = /**
     * @param {?} hierarchicalRecord
     * @return {?}
     */
    function (hierarchicalRecord) {
        var /** @type {?} */ rec = {
            rowID: hierarchicalRecord.rowID,
            data: hierarchicalRecord.data,
            children: hierarchicalRecord.children,
            isFilteredOutParent: hierarchicalRecord.isFilteredOutParent,
            level: hierarchicalRecord.level,
            expanded: hierarchicalRecord.expanded,
            path: tslib_1.__spread(hierarchicalRecord.path)
        };
        return rec;
    };
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    DataUtil.group = /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    function (data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        // apply default settings for each grouping expression(if not set)
        return state.strategy.groupBy(data, state.expressions);
    };
    /**
     * @param {?} groupData
     * @param {?} state
     * @param {?=} groupsRecords
     * @return {?}
     */
    DataUtil.restoreGroups = /**
     * @param {?} groupData
     * @param {?} state
     * @param {?=} groupsRecords
     * @return {?}
     */
    function (groupData, state, groupsRecords) {
        if (groupsRecords === void 0) { groupsRecords = []; }
        DataUtil.mergeDefaultProperties(state, SortingStateDefaults);
        if (state.expressions.length === 0) {
            return groupData.data;
        }
        return this.restoreGroupsRecursive(groupData, 1, state.expressions.length, state.expansion, state.defaultExpanded, groupsRecords);
    };
    /**
     * @param {?} groupData
     * @param {?} level
     * @param {?} depth
     * @param {?} expansion
     * @param {?} defaultExpanded
     * @param {?} groupsRecords
     * @return {?}
     */
    DataUtil.restoreGroupsRecursive = /**
     * @param {?} groupData
     * @param {?} level
     * @param {?} depth
     * @param {?} expansion
     * @param {?} defaultExpanded
     * @param {?} groupsRecords
     * @return {?}
     */
    function (groupData, level, depth, expansion, defaultExpanded, groupsRecords) {
        var _this = this;
        var /** @type {?} */ i = 0;
        var /** @type {?} */ j;
        var /** @type {?} */ result = [];
        // empty the array without changing reference
        groupsRecords.splice(0, groupsRecords.length);
        if (level !== depth) {
            groupData.data = this.restoreGroupsRecursive(groupData, level + 1, depth, expansion, defaultExpanded, groupsRecords);
        }
        var _loop_1 = function () {
            var /** @type {?} */ g = level === depth ? groupData.metadata[i] :
                groupData.data[i].groupParent;
            for (j = i + 1; j < groupData.data.length; j++) {
                var /** @type {?} */ h = level === depth ? groupData.metadata[j] :
                    groupData.data[j].groupParent;
                if (h && g !== h && g.level === h.level) {
                    break;
                }
            }
            var /** @type {?} */ hierarchy = this_1.getHierarchy(g);
            var /** @type {?} */ expandState = expansion.find(function (state) {
                return _this.isHierarchyMatch(state.hierarchy || [{ fieldName: g.expression.fieldName, value: g.value }], hierarchy);
            });
            var /** @type {?} */ expanded = expandState ? expandState.expanded : defaultExpanded;
            result.push(g);
            groupsRecords.push(g);
            g['groups'] = groupData.data.slice(i, j).filter(function (e) {
                return e.records && e.records.length && e.level === g.level + 1;
            });
            while (groupsRecords.length) {
                if (groupsRecords[0].level + 1 > level) {
                    groupsRecords.shift();
                }
                else {
                    break;
                }
            }
            if (expanded) {
                result = result.concat(groupData.data.slice(i, j));
            }
            i = j;
        };
        var this_1 = this;
        while (i < groupData.data.length) {
            _loop_1();
        }
        return result;
    };
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    DataUtil.page = /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    function (data, state) {
        if (!state) {
            return data;
        }
        var /** @type {?} */ len = data.length;
        var /** @type {?} */ index = state.index;
        var /** @type {?} */ res = [];
        var /** @type {?} */ recordsPerPage = state.recordsPerPage;
        state.metadata = {
            countPages: 0,
            countRecords: data.length,
            error: PagingError.None
        };
        if (index < 0 || isNaN(index)) {
            state.metadata.error = PagingError.IncorrectPageIndex;
            return res;
        }
        if (recordsPerPage <= 0 || isNaN(recordsPerPage)) {
            state.metadata.error = PagingError.IncorrectRecordsPerPage;
            return res;
        }
        state.metadata.countPages = Math.ceil(len / recordsPerPage);
        if (!len) {
            return data;
        }
        if (index >= state.metadata.countPages) {
            state.metadata.error = PagingError.IncorrectPageIndex;
            return res;
        }
        return data.slice(index * recordsPerPage, (index + 1) * recordsPerPage);
    };
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    DataUtil.filter = /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    function (data, state) {
        // set defaults
        DataUtil.mergeDefaultProperties(state, filteringStateDefaults);
        if (!state.strategy) {
            return data;
        }
        return state.strategy.filter(data, state.expressionsTree);
    };
    /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    DataUtil.process = /**
     * @template T
     * @param {?} data
     * @param {?} state
     * @return {?}
     */
    function (data, state) {
        if (!state) {
            return data;
        }
        if (state.filtering) {
            data = DataUtil.filter(data, state.filtering);
        }
        if (state.sorting) {
            data = DataUtil.sort(data, state.sorting);
        }
        if (state.paging) {
            data = DataUtil.page(data, state.paging);
        }
        return data;
    };
    /**
     * @param {?} gRow
     * @return {?}
     */
    DataUtil.getHierarchy = /**
     * @param {?} gRow
     * @return {?}
     */
    function (gRow) {
        var /** @type {?} */ hierarchy = [];
        if (gRow !== undefined && gRow.expression) {
            hierarchy.push({ fieldName: gRow.expression.fieldName, value: gRow.value });
            while (gRow.groupParent) {
                gRow = gRow.groupParent;
                hierarchy.unshift({ fieldName: gRow.expression.fieldName, value: gRow.value });
            }
        }
        return hierarchy;
    };
    /**
     * @param {?} h1
     * @param {?} h2
     * @return {?}
     */
    DataUtil.isHierarchyMatch = /**
     * @param {?} h1
     * @param {?} h2
     * @return {?}
     */
    function (h1, h2) {
        if (h1.length !== h2.length) {
            return false;
        }
        return h1.every(function (level, index) {
            return level.fieldName === h2[index].fieldName && level.value === h2[index].value;
        });
    };
    /**
     * Merges all changes from provided transactions into provided data collection
     * @template T
     * @param {?} data Collection to merge
     * @param {?} transactions Transactions to merge into data
     * @param {?=} primaryKey Primary key of the collection, if any
     * @return {?}
     */
    DataUtil.mergeTransactions = /**
     * Merges all changes from provided transactions into provided data collection
     * @template T
     * @param {?} data Collection to merge
     * @param {?} transactions Transactions to merge into data
     * @param {?=} primaryKey Primary key of the collection, if any
     * @return {?}
     */
    function (data, transactions, primaryKey) {
        var _this = this;
        data.forEach(function (item, index) {
            var /** @type {?} */ rowId = primaryKey ? item[primaryKey] : item;
            var /** @type {?} */ transaction = transactions.find(function (t) { return t.id === rowId; });
            if (Array.isArray(item.children)) {
                _this.mergeTransactions(item.children, transactions, primaryKey);
            }
            if (transaction && transaction.type === TransactionType.UPDATE) {
                data[index] = transaction.newValue;
            }
        });
        data.push.apply(data, tslib_1.__spread(transactions
            .filter(function (t) { return t.type === TransactionType.ADD; })
            .map(function (t) { return t.newValue; })));
        return data;
    };
    /**
     * \@experimental \@hidden
     * @param {?} data
     * @param {?} transactions
     * @param {?} childDataKey
     * @param {?=} primaryKey
     * @param {?=} parentKey
     * @return {?}
     */
    DataUtil.mergeHierarchicalTransactions = /**
     * \@experimental \@hidden
     * @param {?} data
     * @param {?} transactions
     * @param {?} childDataKey
     * @param {?=} primaryKey
     * @param {?=} parentKey
     * @return {?}
     */
    function (data, transactions, childDataKey, primaryKey, parentKey) {
        var _loop_2 = function (index) {
            var /** @type {?} */ dataItem = data[index];
            var /** @type {?} */ rowId = primaryKey ? dataItem[primaryKey] : dataItem;
            var /** @type {?} */ updateTransaction = transactions.filter(function (t) { return t.type === TransactionType.UPDATE; }).find(function (t) { return t.id === rowId; });
            var /** @type {?} */ addedTransactions = transactions.filter(function (t) { return t.type === TransactionType.ADD; }).filter(function (t) { return t.parentId === rowId; });
            if (updateTransaction || addedTransactions.length > 0) {
                data[index] = mergeObjects(cloneValue(dataItem), updateTransaction && updateTransaction.newValue);
            }
            if (addedTransactions.length > 0) {
                if (!data[index][childDataKey]) {
                    data[index][childDataKey] = [];
                }
                try {
                    for (var addedTransactions_1 = tslib_1.__values(addedTransactions), addedTransactions_1_1 = addedTransactions_1.next(); !addedTransactions_1_1.done; addedTransactions_1_1 = addedTransactions_1.next()) {
                        var addedTransaction = addedTransactions_1_1.value;
                        data[index][childDataKey].push(addedTransaction.newValue);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (addedTransactions_1_1 && !addedTransactions_1_1.done && (_a = addedTransactions_1.return)) _a.call(addedTransactions_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
            if (data[index][childDataKey]) {
                data[index][childDataKey] = this_2.mergeHierarchicalTransactions(data[index][childDataKey], transactions, childDataKey, primaryKey, rowId);
            }
            var e_1, _a;
        };
        var this_2 = this;
        for (var /** @type {?} */ index = 0; index < data.length; index++) {
            _loop_2(index);
        }
        return data;
    };
    return DataUtil;
}());
/**
 * @hidden
 */
export { DataUtil };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS11dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLHNCQUFzQixFQUFtQixNQUFNLDZCQUE2QixDQUFDO0FBQ3RGLE9BQU8sRUFBaUIsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNoRixPQUFPLEVBQWtCLHVCQUF1QixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0UsT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUtyRSxPQUFPLEVBQWUsZUFBZSxFQUFpRixNQUFNLGFBQWEsQ0FBQztBQUMxSSxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7O1lBTzVDLFFBQVE7WUFDUixRQUFRO2FBQ1AsU0FBUztVQUNaLE1BQU07Ozs7OztBQU1qQjs7O0FBQUE7Ozs7Ozs7O0lBQ2tCLCtCQUFzQjs7Ozs7Y0FBQyxNQUFjLEVBQUUsUUFBZ0I7UUFDakUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ1osTUFBTSxDQUFDLE1BQU0sQ0FBQztTQUNqQjtRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNWLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDO1NBQ2pCO1FBQ0QsTUFBTTthQUNELElBQUksQ0FBQyxRQUFRLENBQUM7YUFDZCxPQUFPLENBQUMsVUFBQyxHQUFHO1lBQ1QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FB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QTs7OztBQTFQRCxvQkEwUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmaWx0ZXJpbmdTdGF0ZURlZmF1bHRzLCBJRmlsdGVyaW5nU3RhdGUgfSBmcm9tICcuL2ZpbHRlcmluZy1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSVNvcnRpbmdTdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMgfSBmcm9tICcuL3NvcnRpbmctc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcm91cEJ5UmVzdWx0LCBUcmVlR3JpZFNvcnRpbmdTdHJhdGVneSB9IGZyb20gJy4vc29ydGluZy1zdHJhdGVneSc7XG5pbXBvcnQgeyBJUGFnaW5nU3RhdGUsIFBhZ2luZ0Vycm9yIH0gZnJvbSAnLi9wYWdpbmctc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElEYXRhU3RhdGUgfSBmcm9tICcuL2RhdGEtc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcm91cEJ5RXhwYW5kU3RhdGUsIElHcm91cEJ5S2V5IH0gZnJvbSAnLi9ncm91cGJ5LWV4cGFuZC1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSUdyb3VwQnlSZWNvcmQgfSBmcm9tICcuL2dyb3VwYnktcmVjb3JkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBJR3JvdXBpbmdTdGF0ZSB9IGZyb20gJy4vZ3JvdXBieS1zdGF0ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb24sIFRyYW5zYWN0aW9uVHlwZSwgSGllcmFyY2hpY2FsVHJhbnNhY3Rpb24sIElneEhpZXJhcmNoaWNhbFRyYW5zYWN0aW9uU2VydmljZSwgSGllcmFyY2hpY2FsU3RhdGUgfSBmcm9tICcuLi9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBtZXJnZU9iamVjdHMsIGNsb25lVmFsdWUgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcbmltcG9ydCB7IElUcmVlR3JpZFJlY29yZCB9IGZyb20gJy4uL2dyaWRzL3RyZWUtZ3JpZC90cmVlLWdyaWQuaW50ZXJmYWNlcyc7XG5cbi8qKlxuICogQGhpZGRlblxuICovXG5leHBvcnQgZW51bSBEYXRhVHlwZSB7XG4gICAgU3RyaW5nID0gJ3N0cmluZycsXG4gICAgTnVtYmVyID0gJ251bWJlcicsXG4gICAgQm9vbGVhbiA9ICdib29sZWFuJyxcbiAgICBEYXRlID0gJ2RhdGUnXG59XG5cbi8qKlxuICogQGhpZGRlblxuICovXG5leHBvcnQgY2xhc3MgRGF0YVV0aWwge1xuICAgIHB1YmxpYyBzdGF0aWMgbWVyZ2VEZWZhdWx0UHJvcGVydGllcyh0YXJnZXQ6IG9iamVjdCwgZGVmYXVsdHM6IG9iamVjdCkge1xuICAgICAgICBpZiAoIWRlZmF1bHRzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXQgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0cyk7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICB9XG4gICAgICAgIE9iamVjdFxuICAgICAgICAgICAgLmtleXMoZGVmYXVsdHMpXG4gICAgICAgICAgICAuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldFtrZXldID09PSB1bmRlZmluZWQgJiYgZGVmYXVsdHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gZGVmYXVsdHNba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBzb3J0PFQ+KGRhdGE6IFRbXSwgc3RhdGU6IElTb3J0aW5nU3RhdGUpOiBUW10ge1xuICAgICAgICAvLyBzZXQgZGVmYXVsdHNcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMpO1xuICAgICAgICAvLyBhcHBseSBkZWZhdWx0IHNldHRpbmdzIGZvciBlYWNoIHNvcnRpbmcgZXhwcmVzc2lvbihpZiBub3Qgc2V0KVxuICAgICAgICByZXR1cm4gc3RhdGUuc3RyYXRlZ3kuc29ydChkYXRhLCBzdGF0ZS5leHByZXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBoaWVyYXJjaGljYWxTb3J0KGhpZXJhcmNoaWNhbERhdGE6IElUcmVlR3JpZFJlY29yZFtdLCBzdGF0ZTogSVNvcnRpbmdTdGF0ZSwgcGFyZW50OiBJVHJlZUdyaWRSZWNvcmQpOiBJVHJlZUdyaWRSZWNvcmRbXSB7XG4gICAgICAgIHN0YXRlLnN0cmF0ZWd5ID0gbmV3IFRyZWVHcmlkU29ydGluZ1N0cmF0ZWd5KCk7XG4gICAgICAgIGxldCByZXM6IElUcmVlR3JpZFJlY29yZFtdID0gW107XG5cbiAgICAgICAgaGllcmFyY2hpY2FsRGF0YS5mb3JFYWNoKChocjogSVRyZWVHcmlkUmVjb3JkKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWM6IElUcmVlR3JpZFJlY29yZCA9IERhdGFVdGlsLmNsb25lVHJlZUdyaWRSZWNvcmQoaHIpO1xuICAgICAgICAgICAgcmVjLnBhcmVudCA9IHBhcmVudDtcbiAgICAgICAgICAgIGlmIChyZWMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICByZWMuY2hpbGRyZW4gPSBEYXRhVXRpbC5oaWVyYXJjaGljYWxTb3J0KHJlYy5jaGlsZHJlbiwgc3RhdGUsIHJlYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXMucHVzaChyZWMpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXMgPSBEYXRhVXRpbC5zb3J0KHJlcywgc3RhdGUpO1xuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBjbG9uZVRyZWVHcmlkUmVjb3JkKGhpZXJhcmNoaWNhbFJlY29yZDogSVRyZWVHcmlkUmVjb3JkKSB7XG4gICAgICAgIGNvbnN0IHJlYzogSVRyZWVHcmlkUmVjb3JkID0ge1xuICAgICAgICAgICAgcm93SUQ6IGhpZXJhcmNoaWNhbFJlY29yZC5yb3dJRCxcbiAgICAgICAgICAgIGRhdGE6IGhpZXJhcmNoaWNhbFJlY29yZC5kYXRhLFxuICAgICAgICAgICAgY2hpbGRyZW46IGhpZXJhcmNoaWNhbFJlY29yZC5jaGlsZHJlbixcbiAgICAgICAgICAgIGlzRmlsdGVyZWRPdXRQYXJlbnQ6IGhpZXJhcmNoaWNhbFJlY29yZC5pc0ZpbHRlcmVkT3V0UGFyZW50LFxuICAgICAgICAgICAgbGV2ZWw6IGhpZXJhcmNoaWNhbFJlY29yZC5sZXZlbCxcbiAgICAgICAgICAgIGV4cGFuZGVkOiBoaWVyYXJjaGljYWxSZWNvcmQuZXhwYW5kZWQsXG4gICAgICAgICAgICBwYXRoOiBbLi4uaGllcmFyY2hpY2FsUmVjb3JkLnBhdGhdXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiByZWM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBncm91cDxUPihkYXRhOiBUW10sIHN0YXRlOiBJR3JvdXBpbmdTdGF0ZSk6IElHcm91cEJ5UmVzdWx0IHtcbiAgICAgICAgLy8gc2V0IGRlZmF1bHRzXG4gICAgICAgIERhdGFVdGlsLm1lcmdlRGVmYXVsdFByb3BlcnRpZXMoc3RhdGUsIFNvcnRpbmdTdGF0ZURlZmF1bHRzKTtcbiAgICAgICAgLy8gYXBwbHkgZGVmYXVsdCBzZXR0aW5ncyBmb3IgZWFjaCBncm91cGluZyBleHByZXNzaW9uKGlmIG5vdCBzZXQpXG4gICAgICAgIHJldHVybiBzdGF0ZS5zdHJhdGVneS5ncm91cEJ5KGRhdGEsIHN0YXRlLmV4cHJlc3Npb25zKTtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyByZXN0b3JlR3JvdXBzKGdyb3VwRGF0YTogSUdyb3VwQnlSZXN1bHQsIHN0YXRlOiBJR3JvdXBpbmdTdGF0ZSwgZ3JvdXBzUmVjb3JkczogYW55W10gPSBbXSk6IGFueVtdIHtcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgU29ydGluZ1N0YXRlRGVmYXVsdHMpO1xuICAgICAgICBpZiAoc3RhdGUuZXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3JvdXBEYXRhLmRhdGE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdG9yZUdyb3Vwc1JlY3Vyc2l2ZShncm91cERhdGEsIDEsIHN0YXRlLmV4cHJlc3Npb25zLmxlbmd0aCwgc3RhdGUuZXhwYW5zaW9uLCBzdGF0ZS5kZWZhdWx0RXhwYW5kZWQsIGdyb3Vwc1JlY29yZHMpO1xuICAgIH1cbiAgICBwcml2YXRlIHN0YXRpYyByZXN0b3JlR3JvdXBzUmVjdXJzaXZlKFxuICAgICAgICBncm91cERhdGE6IElHcm91cEJ5UmVzdWx0LCBsZXZlbDogbnVtYmVyLCBkZXB0aDogbnVtYmVyLFxuICAgICAgICBleHBhbnNpb246IElHcm91cEJ5RXhwYW5kU3RhdGVbXSwgZGVmYXVsdEV4cGFuZGVkOiBib29sZWFuLCBncm91cHNSZWNvcmRzKTogYW55W10ge1xuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGxldCBqOiBudW1iZXI7XG4gICAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgICAgLy8gZW1wdHkgdGhlIGFycmF5IHdpdGhvdXQgY2hhbmdpbmcgcmVmZXJlbmNlXG4gICAgICAgIGdyb3Vwc1JlY29yZHMuc3BsaWNlKDAsIGdyb3Vwc1JlY29yZHMubGVuZ3RoKTtcbiAgICAgICAgaWYgKGxldmVsICE9PSBkZXB0aCkge1xuICAgICAgICAgICAgZ3JvdXBEYXRhLmRhdGEgPSB0aGlzLnJlc3RvcmVHcm91cHNSZWN1cnNpdmUoZ3JvdXBEYXRhLCBsZXZlbCArIDEsIGRlcHRoLCBleHBhbnNpb24sIGRlZmF1bHRFeHBhbmRlZCwgZ3JvdXBzUmVjb3Jkcyk7XG4gICAgICAgIH1cbiAgICAgICAgd2hpbGUgKGkgPCBncm91cERhdGEuZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGcgPSBsZXZlbCA9PT0gZGVwdGggPyBncm91cERhdGEubWV0YWRhdGFbaV0gOlxuICAgICAgICAgICAgICAgIGdyb3VwRGF0YS5kYXRhW2ldLmdyb3VwUGFyZW50O1xuICAgICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBncm91cERhdGEuZGF0YS5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGggPSBsZXZlbCA9PT0gZGVwdGggPyBncm91cERhdGEubWV0YWRhdGFbal0gOlxuICAgICAgICAgICAgICAgICAgICBncm91cERhdGEuZGF0YVtqXS5ncm91cFBhcmVudDtcbiAgICAgICAgICAgICAgICBpZiAoaCAmJiBnICE9PSBoICYmIGcubGV2ZWwgPT09IGgubGV2ZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gdGhpcy5nZXRIaWVyYXJjaHkoZyk7XG4gICAgICAgICAgICBjb25zdCBleHBhbmRTdGF0ZTogSUdyb3VwQnlFeHBhbmRTdGF0ZSA9IGV4cGFuc2lvbi5maW5kKChzdGF0ZSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLmlzSGllcmFyY2h5TWF0Y2goc3RhdGUuaGllcmFyY2h5IHx8IFt7IGZpZWxkTmFtZTogZy5leHByZXNzaW9uLmZpZWxkTmFtZSwgdmFsdWU6IGcudmFsdWUgfV0sIGhpZXJhcmNoeSkpO1xuICAgICAgICAgICAgY29uc3QgZXhwYW5kZWQgPSBleHBhbmRTdGF0ZSA/IGV4cGFuZFN0YXRlLmV4cGFuZGVkIDogZGVmYXVsdEV4cGFuZGVkO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goZyk7XG4gICAgICAgICAgICBncm91cHNSZWNvcmRzLnB1c2goZyk7XG5cbiAgICAgICAgICAgIGdbJ2dyb3VwcyddID0gZ3JvdXBEYXRhLmRhdGEuc2xpY2UoaSwgaikuZmlsdGVyKChlKSA9PlxuICAgICAgICAgICAgICAgIGUucmVjb3JkcyAmJiBlLnJlY29yZHMubGVuZ3RoICYmIGUubGV2ZWwgPT09IGcubGV2ZWwgKyAxKTtcbiAgICAgICAgICAgIHdoaWxlIChncm91cHNSZWNvcmRzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGlmIChncm91cHNSZWNvcmRzWzBdLmxldmVsICsgMSA+IGxldmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGdyb3Vwc1JlY29yZHMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXhwYW5kZWQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGdyb3VwRGF0YS5kYXRhLnNsaWNlKGksIGopKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGkgPSBqO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHB1YmxpYyBzdGF0aWMgcGFnZTxUPihkYXRhOiBUW10sIHN0YXRlOiBJUGFnaW5nU3RhdGUpOiBUW10ge1xuICAgICAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsZW4gPSBkYXRhLmxlbmd0aDtcbiAgICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5pbmRleDtcbiAgICAgICAgY29uc3QgcmVzID0gW107XG4gICAgICAgIGNvbnN0IHJlY29yZHNQZXJQYWdlID0gc3RhdGUucmVjb3Jkc1BlclBhZ2U7XG4gICAgICAgIHN0YXRlLm1ldGFkYXRhID0ge1xuICAgICAgICAgICAgY291bnRQYWdlczogMCxcbiAgICAgICAgICAgIGNvdW50UmVjb3JkczogZGF0YS5sZW5ndGgsXG4gICAgICAgICAgICBlcnJvcjogUGFnaW5nRXJyb3IuTm9uZVxuICAgICAgICB9O1xuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGlzTmFOKGluZGV4KSkge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RQYWdlSW5kZXg7XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWNvcmRzUGVyUGFnZSA8PSAwIHx8IGlzTmFOKHJlY29yZHNQZXJQYWdlKSkge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RSZWNvcmRzUGVyUGFnZTtcbiAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUubWV0YWRhdGEuY291bnRQYWdlcyA9IE1hdGguY2VpbChsZW4gLyByZWNvcmRzUGVyUGFnZSk7XG4gICAgICAgIGlmICghbGVuKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5kZXggPj0gc3RhdGUubWV0YWRhdGEuY291bnRQYWdlcykge1xuICAgICAgICAgICAgc3RhdGUubWV0YWRhdGEuZXJyb3IgPSBQYWdpbmdFcnJvci5JbmNvcnJlY3RQYWdlSW5kZXg7XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhLnNsaWNlKGluZGV4ICogcmVjb3Jkc1BlclBhZ2UsIChpbmRleCArIDEpICogcmVjb3Jkc1BlclBhZ2UpO1xuICAgIH1cbiAgICBwdWJsaWMgc3RhdGljIGZpbHRlcjxUPihkYXRhOiBUW10sIHN0YXRlOiBJRmlsdGVyaW5nU3RhdGUpOiBUW10ge1xuICAgICAgICAvLyBzZXQgZGVmYXVsdHNcbiAgICAgICAgRGF0YVV0aWwubWVyZ2VEZWZhdWx0UHJvcGVydGllcyhzdGF0ZSwgZmlsdGVyaW5nU3RhdGVEZWZhdWx0cyk7XG4gICAgICAgIGlmICghc3RhdGUuc3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGF0ZS5zdHJhdGVneS5maWx0ZXIoZGF0YSwgc3RhdGUuZXhwcmVzc2lvbnNUcmVlKTtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBwcm9jZXNzPFQ+KGRhdGE6IFRbXSwgc3RhdGU6IElEYXRhU3RhdGUpOiBUW10ge1xuICAgICAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhdGUuZmlsdGVyaW5nKSB7XG4gICAgICAgICAgICBkYXRhID0gRGF0YVV0aWwuZmlsdGVyKGRhdGEsIHN0YXRlLmZpbHRlcmluZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXRlLnNvcnRpbmcpIHtcbiAgICAgICAgICAgIGRhdGEgPSBEYXRhVXRpbC5zb3J0KGRhdGEsIHN0YXRlLnNvcnRpbmcpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZS5wYWdpbmcpIHtcbiAgICAgICAgICAgIGRhdGEgPSBEYXRhVXRpbC5wYWdlKGRhdGEsIHN0YXRlLnBhZ2luZyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRIaWVyYXJjaHkoZ1JvdzogSUdyb3VwQnlSZWNvcmQpOiBBcnJheTxJR3JvdXBCeUtleT4ge1xuICAgICAgICBjb25zdCBoaWVyYXJjaHk6IEFycmF5PElHcm91cEJ5S2V5PiA9IFtdO1xuICAgICAgICBpZiAoZ1JvdyAhPT0gdW5kZWZpbmVkICYmIGdSb3cuZXhwcmVzc2lvbikge1xuICAgICAgICAgICAgaGllcmFyY2h5LnB1c2goeyBmaWVsZE5hbWU6IGdSb3cuZXhwcmVzc2lvbi5maWVsZE5hbWUsIHZhbHVlOiBnUm93LnZhbHVlIH0pO1xuICAgICAgICAgICAgd2hpbGUgKGdSb3cuZ3JvdXBQYXJlbnQpIHtcbiAgICAgICAgICAgICAgICBnUm93ID0gZ1Jvdy5ncm91cFBhcmVudDtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkudW5zaGlmdCh7IGZpZWxkTmFtZTogZ1Jvdy5leHByZXNzaW9uLmZpZWxkTmFtZSwgdmFsdWU6IGdSb3cudmFsdWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhpZXJhcmNoeTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGlzSGllcmFyY2h5TWF0Y2goaDE6IEFycmF5PElHcm91cEJ5S2V5PiwgaDI6IEFycmF5PElHcm91cEJ5S2V5Pik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoaDEubGVuZ3RoICE9PSBoMi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaDEuZXZlcnkoKGxldmVsLCBpbmRleCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGxldmVsLmZpZWxkTmFtZSA9PT0gaDJbaW5kZXhdLmZpZWxkTmFtZSAmJiBsZXZlbC52YWx1ZSA9PT0gaDJbaW5kZXhdLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNZXJnZXMgYWxsIGNoYW5nZXMgZnJvbSBwcm92aWRlZCB0cmFuc2FjdGlvbnMgaW50byBwcm92aWRlZCBkYXRhIGNvbGxlY3Rpb25cbiAgICAgKiBAcGFyYW0gZGF0YSBDb2xsZWN0aW9uIHRvIG1lcmdlXG4gICAgICogQHBhcmFtIHRyYW5zYWN0aW9ucyBUcmFuc2FjdGlvbnMgdG8gbWVyZ2UgaW50byBkYXRhXG4gICAgICogQHBhcmFtIHByaW1hcnlLZXkgUHJpbWFyeSBrZXkgb2YgdGhlIGNvbGxlY3Rpb24sIGlmIGFueVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgbWVyZ2VUcmFuc2FjdGlvbnM8VD4oZGF0YTogVFtdLCB0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9uW10sIHByaW1hcnlLZXk/OiBhbnkpOiBUW10ge1xuICAgICAgICBkYXRhLmZvckVhY2goKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm93SWQgPSBwcmltYXJ5S2V5ID8gaXRlbVtwcmltYXJ5S2V5XSA6IGl0ZW07XG4gICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9ucy5maW5kKHQgPT4gdC5pZCA9PT0gcm93SWQpO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1lcmdlVHJhbnNhY3Rpb25zKGl0ZW0uY2hpbGRyZW4sIHRyYW5zYWN0aW9ucywgcHJpbWFyeUtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHJhbnNhY3Rpb24gJiYgdHJhbnNhY3Rpb24udHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlVQREFURSkge1xuICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdID0gdHJhbnNhY3Rpb24ubmV3VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRhdGEucHVzaCguLi50cmFuc2FjdGlvbnNcbiAgICAgICAgICAgIC5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5BREQpXG4gICAgICAgICAgICAubWFwKHQgPT4gdC5uZXdWYWx1ZSkpO1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBvcHRpbWl6ZSBhZGRpdGlvbiBvZiBhZGRlZCByb3dzLiBTaG91bGQgbm90IGZpbHRlciB0cmFuc2FjdGlvbiBpbiBlYWNoIHJlY3Vyc2lvbiEhIVxuICAgIC8qKiBAZXhwZXJpbWVudGFsIEBoaWRkZW4gKi9cbiAgICBwdWJsaWMgc3RhdGljIG1lcmdlSGllcmFyY2hpY2FsVHJhbnNhY3Rpb25zKFxuICAgICAgICBkYXRhOiBhbnlbXSxcbiAgICAgICAgdHJhbnNhY3Rpb25zOiBIaWVyYXJjaGljYWxUcmFuc2FjdGlvbltdLFxuICAgICAgICBjaGlsZERhdGFLZXk6IGFueSxcbiAgICAgICAgcHJpbWFyeUtleT86IGFueSxcbiAgICAgICAgcGFyZW50S2V5PzogYW55KTogYW55W10ge1xuXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgICAgY29uc3QgZGF0YUl0ZW0gPSBkYXRhW2luZGV4XTtcbiAgICAgICAgICAgIGNvbnN0IHJvd0lkID0gcHJpbWFyeUtleSA/IGRhdGFJdGVtW3ByaW1hcnlLZXldIDogZGF0YUl0ZW07XG4gICAgICAgICAgICBjb25zdCB1cGRhdGVUcmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9ucy5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5VUERBVEUpLmZpbmQodCA9PiB0LmlkID09PSByb3dJZCk7XG4gICAgICAgICAgICBjb25zdCBhZGRlZFRyYW5zYWN0aW9ucyA9IHRyYW5zYWN0aW9ucy5maWx0ZXIodCA9PiB0LnR5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5BREQpLmZpbHRlcih0ID0+IHQucGFyZW50SWQgPT09IHJvd0lkKTtcbiAgICAgICAgICAgIGlmICh1cGRhdGVUcmFuc2FjdGlvbiB8fCBhZGRlZFRyYW5zYWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgZGF0YVtpbmRleF0gPSBtZXJnZU9iamVjdHMoY2xvbmVWYWx1ZShkYXRhSXRlbSksIHVwZGF0ZVRyYW5zYWN0aW9uICYmIHVwZGF0ZVRyYW5zYWN0aW9uLm5ld1ZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhZGRlZFRyYW5zYWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFkYXRhW2luZGV4XVtjaGlsZERhdGFLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0gPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBhZGRlZFRyYW5zYWN0aW9uIG9mIGFkZGVkVHJhbnNhY3Rpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0ucHVzaChhZGRlZFRyYW5zYWN0aW9uLm5ld1ZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGF0YVtpbmRleF1bY2hpbGREYXRhS2V5XSkge1xuICAgICAgICAgICAgICAgIGRhdGFbaW5kZXhdW2NoaWxkRGF0YUtleV0gPSB0aGlzLm1lcmdlSGllcmFyY2hpY2FsVHJhbnNhY3Rpb25zKFxuICAgICAgICAgICAgICAgICAgICBkYXRhW2luZGV4XVtjaGlsZERhdGFLZXldLFxuICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkRGF0YUtleSxcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgICAgICAgICAgICAgcm93SWRcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbn1cbiJdfQ==